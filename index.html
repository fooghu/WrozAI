<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="WrÃ³Å¼AI">
<meta name="theme-color" content="#0d1120">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Raleway:wght@300;400;600;700&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<title>WrÃ³Å¼AI Â· Zegar Astrologiczny</title>
<style>
:root {
  --bg:#0d1120; --surface:#111828; --surface2:#161f35; --surface3:#1a2540;
  --accent:#7ba4d4; --accent2:#5585ba; --gold:#c8a040; --gold2:#e8c060;
  --teal:#2aa8b8; --muted:#6880a8; --border:#1e2d4a; --border2:#2a3d60;
  --red:#e05555; --green:#4ade80; --shadow:0 4px 28px rgba(0,0,0,.6);
  --r:12px;
}
body.light {
  --bg:#f0f4fb; --surface:#fff; --surface2:#f8faff; --surface3:#eef4ff;
  --accent:#1e3a5f; --accent2:#2d5a8e; --gold:#9a6f20; --gold2:#c49030;
  --teal:#1a7a8a; --muted:#6070a0; --border:#dce4f4; --border2:#b0c4dc;
  --red:#b03030; --shadow:0 4px 28px rgba(30,58,95,.14);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg);
  font-family:'Raleway',sans-serif;
  color:#c8d8f0;
  min-height:100vh;
  padding-bottom:env(safe-area-inset-bottom);
}
body.light{color:#1e3a5f;}

/* â”€â”€ BOTTOM NAV â”€â”€ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);
  border-top:1px solid var(--border);
  display:flex;
  padding-bottom:env(safe-area-inset-bottom);
  z-index:100;
}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;
  padding:10px 4px 8px;gap:3px;cursor:pointer;
  color:var(--muted);font-size:8px;font-weight:700;letter-spacing:1px;
  text-transform:uppercase;border:none;background:none;
  transition:color .2s;
}
.nav-btn.active{color:var(--gold);}
.nav-icon{font-size:20px;line-height:1;}

/* â”€â”€ SCREENS â”€â”€ */
.screen{display:none;min-height:calc(100vh - 60px);padding:16px 12px 80px;}
.screen.active{display:block;}

/* â”€â”€ HEADER â”€â”€ */
.app-header{
  text-align:center;padding:20px 16px 14px;
  background:linear-gradient(180deg,var(--surface) 0%,transparent 100%);
}
.app-title{
  font-family:'Cinzel',serif;font-size:22px;font-weight:700;
  color:var(--gold);letter-spacing:4px;text-transform:uppercase;
  text-shadow:0 0 30px rgba(200,160,64,.4);
}
.app-subtitle{font-family:'Lora',serif;font-style:italic;color:var(--muted);font-size:12px;margin-top:3px;}
.accent-bar{width:40px;height:2px;background:linear-gradient(90deg,var(--accent),var(--gold));border-radius:1px;margin:8px auto 0;}

/* â”€â”€ CARDS â”€â”€ */
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:12px;overflow:hidden;
  box-shadow:var(--shadow);
}
.card-header{
  background:linear-gradient(135deg,rgba(30,58,95,.8) 0%,rgba(45,90,142,.6) 100%);
  border-bottom:1px solid var(--border);
  padding:10px 16px;display:flex;align-items:center;gap:8px;
}
.card-title{font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(200,220,255,.85);}
.card-body{padding:14px 16px;}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{
  border:1px solid var(--border2);background:var(--surface2);
  color:var(--accent);font-family:'Raleway',sans-serif;
  font-size:11px;font-weight:700;letter-spacing:.5px;
  padding:7px 14px;border-radius:6px;cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.btn:hover{background:var(--surface3);border-color:var(--accent);}
.btn:active{transform:scale(.97);}
.btn.primary{background:var(--accent2);color:#fff;border-color:var(--accent2);}
.btn.primary:hover{background:var(--accent);}
.btn.gold{background:linear-gradient(135deg,#3a2800,#2a1d00);color:var(--gold);border-color:#5a4010;}
.btn.gold:hover{background:linear-gradient(135deg,#4a3800,#3a2d00);}
.btn.danger{background:rgba(180,30,30,.15);color:var(--red);border-color:rgba(180,30,30,.3);}
.btn.sm{padding:5px 10px;font-size:10px;}
.btn.active{background:var(--teal);color:#fff;border-color:var(--teal);}

/* â”€â”€ INPUTS â”€â”€ */
.field{margin-bottom:12px;}
.field label{display:block;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.input{
  width:100%;background:var(--surface3);border:1px solid var(--border2);
  color:inherit;font-family:'Raleway',sans-serif;font-size:13px;
  padding:9px 12px;border-radius:6px;outline:none;
  transition:border .15s;
}
.input:focus{border-color:var(--accent);}
body.light .input{color:#1e3a5f;}
.input-row{display:flex;gap:8px;}
.input-row .field{flex:1;}

/* â”€â”€ LIVE BADGE â”€â”€ */
.live-badge{display:flex;align-items:center;gap:5px;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite;}
.live-dot.paused{background:var(--red);animation:none;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€ WHEEL â”€â”€ */
.wheel-wrap{background:radial-gradient(ellipse at center,#131c32 0%,#0a1020 100%);display:flex;justify-content:center;padding:16px;}
body.light .wheel-wrap{background:radial-gradient(ellipse at center,#eef2fb 0%,#e0e8f8 100%);}
#horoscope-wheel{width:100%;max-width:540px;height:auto;filter:drop-shadow(0 3px 16px rgba(100,150,220,.2));}

/* â”€â”€ TIME CONTROLS â”€â”€ */
.current-time{text-align:center;font-size:12px;font-weight:600;color:var(--accent);padding:8px 0;}
.step-row{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin:6px 0;}
.picker-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center;padding:6px 0;}
.date-input{
  background:var(--surface3);border:1px solid var(--border2);color:inherit;
  font-family:'Raleway',sans-serif;font-size:12px;padding:6px 8px;border-radius:6px;
  outline:none;
}
body.light .date-input{color:#1e3a5f;}
.anim-row{display:flex;gap:4px;justify-content:center;flex-wrap:wrap;padding:6px 0 0;}

/* â”€â”€ MOON BAR â”€â”€ */
.moon-bar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-top:1px solid var(--border);}
.moon-emoji{font-size:28px;flex-shrink:0;}
.moon-info{flex:1;}
.moon-name{font-size:11px;font-weight:700;color:var(--accent);letter-spacing:.5px;margin-bottom:4px;}
.moon-track{height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.moon-fill{height:100%;background:linear-gradient(90deg,var(--gold),#ff9900);border-radius:3px;transition:width .5s ease;}
.moon-pct{font-size:14px;font-weight:700;color:var(--gold2);}

/* â”€â”€ PLANET TABLE â”€â”€ */
.planet-table{width:100%;border-collapse:collapse;}
.planet-table thead th{
  padding:8px 10px;font-size:9px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--muted);text-align:left;
  border-bottom:1px solid var(--border);
}
.planet-table tbody tr{border-bottom:1px solid var(--border);transition:background .12s;}
.planet-table tbody tr:hover{background:var(--surface2);}
.planet-table td{padding:9px 10px;vertical-align:middle;}
.td-sym{font-size:19px;width:28px;}
.td-name{font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--accent);width:80px;}
.td-sign{display:flex;align-items:center;gap:5px;}
.sign-sym{font-size:15px;}
.sign-nm{font-family:'Lora',serif;font-style:italic;font-size:13px;color:var(--teal);}
.retro{color:var(--red);font-size:9px;font-weight:700;background:rgba(180,30,30,.15);padding:2px 5px;border-radius:3px;}
.deg-pill{
  display:inline-block;font-size:11px;font-weight:700;
  background:linear-gradient(135deg,rgba(200,160,64,.2),rgba(200,160,64,.1));
  color:var(--gold);padding:3px 9px;border-radius:10px;
}

/* â”€â”€ ASPECT LEGEND â”€â”€ */
.aspect-legend{display:flex;gap:6px;flex-wrap:wrap;padding:10px 16px;border-top:1px solid var(--border);}
.asp-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);}
.asp-line{width:18px;height:2px;border-radius:1px;flex-shrink:0;}

/* â”€â”€ PROFILES â”€â”€ */
.profile-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:14px;margin-bottom:10px;
  display:flex;align-items:center;gap:12px;cursor:pointer;
  transition:all .2s;
}
.profile-card:hover{border-color:var(--accent);}
.profile-card.selected{border-color:var(--gold);background:rgba(200,160,64,.08);}
.profile-avatar{
  width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent2),var(--teal));
  display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;
}
.profile-info{flex:1;}
.profile-name{font-size:14px;font-weight:700;color:var(--accent);}
.profile-birth{font-size:11px;color:var(--muted);margin-top:2px;}
.profile-sun{font-size:11px;color:var(--gold);margin-top:2px;}
.profile-actions{display:flex;gap:6px;}

/* â”€â”€ TRANSITS â”€â”€ */
.transit-item{
  padding:12px 16px;border-bottom:1px solid var(--border);
  display:flex;gap:10px;align-items:flex-start;
}
.transit-item:last-child{border-bottom:none;}
.transit-icon{
  width:36px;height:36px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
}
.transit-icon.conj{background:rgba(100,100,200,.2);color:#aaaaff;}
.transit-icon.trine{background:rgba(40,160,80,.2);color:#80e0a0;}
.transit-icon.square{background:rgba(200,50,50,.2);color:#ff9090;}
.transit-icon.opp{background:rgba(180,40,40,.2);color:#ff8080;}
.transit-icon.sext{background:rgba(40,120,200,.2);color:#80b8ff;}
.transit-meta{flex:1;}
.transit-planets{font-size:12px;font-weight:700;color:var(--accent);}
.transit-aspect{font-size:11px;color:var(--muted);margin-top:2px;}
.transit-date{font-size:11px;color:var(--gold);margin-top:3px;font-weight:600;}
.transit-orb{
  font-size:10px;font-weight:700;
  background:var(--surface3);border:1px solid var(--border2);
  color:var(--muted);padding:2px 7px;border-radius:8px;
  white-space:nowrap;align-self:center;
}

/* â”€â”€ NOTIFICATIONS â”€â”€ */
.notif-toggle{display:flex;align-items:center;justify-content:space-between;padding:12px 0;}
.toggle-switch{
  width:44px;height:24px;border-radius:12px;background:var(--border);
  position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;
}
.toggle-switch.on{background:var(--teal);}
.toggle-knob{
  width:20px;height:20px;border-radius:50%;background:#fff;
  position:absolute;top:2px;left:2px;transition:left .2s;
  box-shadow:0 1px 4px rgba(0,0,0,.4);
}
.toggle-switch.on .toggle-knob{left:22px;}
.notif-label{font-size:12px;font-weight:600;color:var(--accent);}
.notif-desc{font-size:10px;color:var(--muted);margin-top:2px;}

/* â”€â”€ TOOLTIP â”€â”€ */
#planetTooltip{
  position:fixed;z-index:9999;display:flex;align-items:center;gap:8px;
  background:rgba(10,18,40,0.96);border:1px solid rgba(100,140,220,.3);
  border-radius:8px;padding:7px 13px;pointer-events:none;white-space:nowrap;
  box-shadow:0 4px 20px rgba(0,0,0,.5);
}
.tip-sym{font-size:18px;}
.tip-name{font-size:11px;font-weight:700;color:#b8d0ff;letter-spacing:1px;text-transform:uppercase;}
.tip-deg{font-size:13px;font-weight:800;color:var(--gold);}

/* â”€â”€ LOADING â”€â”€ */
#loadingMsg{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(10,15,30,0.92);z-index:999;
  align-items:center;justify-content:center;flex-direction:column;gap:14px;
  color:#c0d0f0;font-size:14px;letter-spacing:2px;
}
.spinner{width:40px;height:40px;border:3px solid rgba(120,160,220,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .9s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(5,10,25,.85);z-index:200;
  align-items:flex-end;justify-content:center;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:16px 16px 0 0;padding:20px 20px calc(20px + env(safe-area-inset-bottom));
  width:100%;max-width:500px;max-height:85vh;overflow-y:auto;
}
.modal-title{font-family:'Cinzel',serif;font-size:16px;font-weight:600;color:var(--gold);margin-bottom:16px;letter-spacing:2px;}
.modal-actions{display:flex;gap:8px;margin-top:16px;}

/* â”€â”€ MISC â”€â”€ */
.sect-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-state .es-icon{font-size:48px;margin-bottom:12px;opacity:.5;}
.empty-state p{font-size:13px;line-height:1.6;}
.tag{
  display:inline-block;font-size:9px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;padding:2px 7px;border-radius:8px;
  background:rgba(200,160,64,.15);color:var(--gold);border:1px solid rgba(200,160,64,.2);
}
.row{display:flex;gap:8px;align-items:center;}
.row.between{justify-content:space-between;}
.divider{height:1px;background:var(--border);margin:12px 0;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.fade-in{animation:fadeIn .3s ease both;}

/* Header toolbar */
.header-toolbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 4px;}
.ht-title{font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;}

/* Install banner */
.install-banner{
  background:linear-gradient(135deg,rgba(30,58,95,.6),rgba(42,168,184,.2));
  border:1px solid rgba(42,168,184,.3);border-radius:8px;
  padding:12px 14px;margin-bottom:12px;display:flex;align-items:center;gap:12px;
}
.install-banner .ib-text{flex:1;font-size:11px;color:var(--teal);}
.install-banner .ib-title{font-weight:700;font-size:13px;color:var(--accent);margin-bottom:3px;}
</style>
</head>
<body>

<div id="loadingMsg"><div class="spinner"></div><span data-i18n="loading">Loading Swiss Ephemerisâ€¦</span></div>
<div id="planetTooltip" style="display:none;">
  <span class="tip-sym"></span>
  <span class="tip-name"></span>
  <span class="tip-deg"></span>
</div>

<!-- ADD PROFILE MODAL -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <div class="modal-title" id="profileModalTitle">âœ¦ <span data-i18n="addProfile">Add Birth Profile</span></div>
    <div class="field"><label data-i18n="name">Name</label><input class="input" id="pName" placeholder="np. Anna"></div>
    <div class="input-row">
      <div class="field"><label data-i18n="birthDate">Birth Date</label><input class="input date-input" type="date" id="pDate"></div>
      <div class="field"><label data-i18n="birthTime">Birth Time</label><input class="input date-input" type="time" id="pTime" value="12:00"></div>
    </div>
    <div class="field">
      <label data-i18n="birthPlace">Birth Place</label>
      <input class="input" id="pPlace" placeholder="np. Warszawa, Polska">
      <div style="font-size:10px;color:var(--muted);margin-top:4px;" data-i18n="birthPlaceHint">Enter city name for house calculation (Ascendant)</div>
    </div>
    <div class="modal-actions">
      <button class="btn primary" id="saveProfileBtn" style="flex:1" data-i18n="saveProfile">Save Profile</button>
      <button class="btn" onclick="closeModal('profileModal')" data-i18n="cancel">Cancel</button>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-screen="sky" onclick="switchScreen('sky')">
    <span class="nav-icon">â—¯</span><span data-i18n="navSky">Sky Now</span>
  </button>
  <button class="nav-btn" data-screen="profiles" onclick="switchScreen('profiles')">
    <span class="nav-icon">â™¦</span><span data-i18n="navProfiles">Profiles</span>
  </button>
  <button class="nav-btn" data-screen="transits" onclick="switchScreen('transits')">
    <span class="nav-icon">âŸ³</span><span data-i18n="navTransits">Transits</span>
  </button>
  <button class="nav-btn" data-screen="settings" onclick="switchScreen('settings')">
    <span class="nav-icon">âš™</span><span data-i18n="navSettings">Settings</span>
  </button>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCREEN 1: SKY NOW                                           -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen active" id="screen-sky">
  <div style="text-align:center;padding:16px 12px 10px;">
    <div class="app-title">WrÃ³Å¼AI</div>
    <div class="app-subtitle"><span data-i18n="appSubtitle">Astrological Clock Â· Swiss Ephemeris</span></div>
    <div class="accent-bar"></div>
  </div>

  <div id="installBanner" style="display:none;" class="install-banner fade-in">
    <span style="font-size:28px">ğŸ“²</span>
    <div class="ib-text">
      <div class="ib-title" data-i18n="installTitle">Install as App</div>
      <span data-i18n="installAndroid">Android: tap â‹® menu â†’ "Add to Home screen"</span><br>
      <span data-i18n="installIphone">iPhone: tap Share â†’ "Add to Home Screen"</span>
    </div>
    <button class="btn sm" onclick="document.getElementById('installBanner').style.display='none'">âœ•</button>
  </div>

  <!-- Zodiac Wheel -->
  <div class="card">
    <div class="card-header">
      <span style="font-size:14px;color:rgba(255,255,255,.7)">â—¯</span>
      <span class="card-title" data-i18n="wheelTitle">Zodiac Wheel Â· Current Sky</span>
      <div style="margin-left:auto;" class="live-badge">
        <span class="live-dot" id="liveDot"></span>
        <span id="liveLabel" data-i18n="live">LIVE</span>
      </div>
    </div>
    <div class="wheel-wrap">
      <svg id="horoscope-wheel" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
    <div class="moon-bar">
      <span class="moon-emoji" id="moonEmoji">ğŸŒ‘</span>
      <div class="moon-info">
        <div class="moon-name" id="moonName">â€”</div>
        <div class="moon-track"><div class="moon-fill" id="moonFill" style="width:0%"></div></div>
      </div>
      <span class="moon-pct" id="moonPct">â€”</span>
    </div>
    <div class="aspect-legend" id="aspectLegend"></div>
  </div>

  <!-- Time Navigation -->
  <div class="card">
    <div class="card-header">
      <span class="card-title" data-i18n="timeNav">â± Time Navigation</span>
      <span class="mode-badge" id="modeBadge" style="margin-left:auto;font-size:9px;background:rgba(200,160,64,.15);color:var(--gold);border:1px solid rgba(200,160,64,.3);padding:2px 8px;border-radius:8px;display:none;" data-i18n="historicalMode">HISTORICAL MODE</span>
    </div>
    <div class="card-body">
      <div class="current-time" id="current-date">â€”</div>
      <div class="step-row">
        <button class="btn sm" data-step="-1" data-unit="week">â—€ <span data-i18n="week">Week</span></button>
        <button class="btn sm" data-step="-1" data-unit="day">â—€ <span data-i18n="day">Day</span></button>
        <button class="btn sm" data-step="-1" data-unit="hour">â—€ <span data-i18n="hr">Hr</span></button>
        <button class="btn sm" data-step="1" data-unit="hour"><span data-i18n="hr">Hr</span> â–¶</button>
        <button class="btn sm" data-step="1" data-unit="day"><span data-i18n="day">Day</span> â–¶</button>
        <button class="btn sm" data-step="1" data-unit="week"><span data-i18n="week">Week</span> â–¶</button>
      </div>
      <div class="picker-row">
        <input type="date" class="date-input" id="datePicker">
        <input type="time" class="date-input" id="timePicker" value="12:00" style="width:86px;">
        <button class="btn primary sm" id="jumpBtn" data-i18n="jump">Jump â†µ</button>
        <button class="btn danger sm" id="nowBtn" data-i18n="now">âŸ³ Now</button>
      </div>
      <div class="anim-row">
        <span style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;" data-i18n="animation">Animation:</span>
        <button class="btn sm" id="animBtn" data-i18n="play">â–¶ Play</button>
        <button class="btn sm" data-animspeed="1">1d/s</button>
        <button class="btn sm active" data-animspeed="7">1w/s</button>
        <button class="btn sm" data-animspeed="30">1m/s</button>
        <button class="btn sm" data-animspeed="-7">â—€ Back</button>
      </div>
    </div>
  </div>

  <!-- Planet Table -->
  <div class="card">
    <div class="card-header">
      <span style="font-size:14px;color:rgba(255,255,255,.7)">â™ƒ</span>
      <span class="card-title" data-i18n="planetPos">Planet Positions</span>
    </div>
    <table class="planet-table">
      <thead><tr>
        <th></th><th data-i18n="planet">Planet</th><th data-i18n="sign">Sign</th><th></th><th style="text-align:right" data-i18n="degrees">Degrees</th>
      </tr></thead>
      <tbody id="planet-tbody"></tbody>
    </table>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCREEN 2: BIRTH PROFILES                                    -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-profiles">
  <div style="padding:16px 0 8px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div class="app-title" style="font-size:16px;letter-spacing:3px;" data-i18n="navProfiles">Profiles</div>
      <div class="app-subtitle" data-i18n="profilesSubtitle">Birth charts & natal data</div>
    </div>
    <button class="btn gold" onclick="openAddProfile()" data-i18n="addProfileBtn">+ Add Profile</button>
  </div>

  <div id="profilesList">
    <div class="empty-state">
      <div class="es-icon">â™¦</div>
      <p data-i18n="noProfiles">No birth profiles yet.<br>Add your first profile to track personal transits.</p>
    </div>
  </div>

  <!-- Natal Chart Display -->
  <div id="natalSection" style="display:none;">
    <div class="card" id="natalCard">
      <div class="card-header">
        <span style="font-size:14px;color:rgba(255,255,255,.7)">â˜½</span>
        <span class="card-title" id="natalCardTitle" data-i18n="natalChart">Natal Chart</span>
      </div>
      <!-- House system info bar -->
      <div id="natalHouseInfo" style="padding:8px 16px;font-size:10px;color:var(--muted);border-bottom:1px solid var(--border);display:flex;gap:12px;flex-wrap:wrap;"></div>
      <div class="wheel-wrap">
        <svg id="natal-wheel" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
      <div class="card-body">
        <!-- Angles summary -->
        <div id="natalAngles" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;"></div>
        <table class="planet-table">
          <thead><tr>
            <th></th><th data-i18n="planet">Planet</th><th data-i18n="sign">Sign</th><th data-i18n="house">House</th><th></th><th style="text-align:right" data-i18n="degrees">Degrees</th>
          </tr></thead>
          <tbody id="natal-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCREEN 3: TRANSITS                                          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-transits">
  <div style="padding:16px 0 12px;">
    <div class="app-title" style="font-size:16px;letter-spacing:3px;" data-i18n="navTransits">Transits</div>
    <div class="app-subtitle" data-i18n="transitsSubtitle">Upcoming planetary aspects to natal positions</div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div class="card-body" style="padding:10px 14px;">
      <div class="row between">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--accent);" data-i18n="profile">Profile</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;" data-i18n="selectProfile">Select whose transits to show</div>
        </div>
        <select class="date-input" id="transitProfileSelect" style="max-width:160px;">
          <option value="" data-i18n="selectProfileOpt">â€” Select Profile â€”</option>
        </select>
      </div>
      <div class="divider"></div>
      <div class="row between">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--accent);" data-i18n="lookAhead">Look ahead</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;" data-i18n="searchWindow">Search window</div>
        </div>
        <select class="date-input" id="transitDays" style="max-width:120px;">
          <option value="30">30 <span data-i18n="days">days</span></option>
          <option value="60">60 <span data-i18n="days">days</span></option>
          <option value="90" selected>90 <span data-i18n="days">days</span></option>
          <option value="180">180 <span data-i18n="days">days</span></option>
          <option value="365">1 <span data-i18n="year">year</span></option>
        </select>
      </div>
      <div class="divider"></div>
      <button class="btn primary" style="width:100%;" id="calcTransitsBtn" data-i18n="calcTransits">Calculate Transits</button>
    </div>
  </div>

  <div id="transitResults">
    <div class="empty-state">
      <div class="es-icon">âŸ³</div>
      <p data-i18n="transitEmpty">Select a birth profile and calculate to see upcoming transits.</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!--  SCREEN 4: SETTINGS                                          -->
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="screen" id="screen-settings">
  <div style="padding:16px 0 12px;">
    <div class="app-title" style="font-size:16px;letter-spacing:3px;" data-i18n="navSettings">Settings</div>
    <div class="app-subtitle" data-i18n="settingsSubtitle">Preferences & notifications</div>
  </div>

  <!-- Language -->
  <div class="card">
    <div class="card-header"><span class="card-title">ğŸŒ <span data-i18n="language">Language</span></span></div>
    <div class="card-body">
      <div style="display:flex;gap:8px;">
        <button class="btn active" id="langEN" onclick="setLang('en')" style="flex:1;">ğŸ‡¬ğŸ‡§ English</button>
        <button class="btn" id="langPL" onclick="setLang('pl')" style="flex:1;">ğŸ‡µğŸ‡± Polski</button>
      </div>
    </div>
  </div>

  <!-- Push Notifications -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">ğŸ”” <span data-i18n="pushNotif">Push Notifications</span></span>
    </div>
    <div class="card-body">
      <div class="notif-toggle">
        <div>
          <div class="notif-label" data-i18n="transitAlerts">Transit Alerts</div>
          <div class="notif-desc" data-i18n="transitAlertsDesc">Notify me of major upcoming transits</div>
        </div>
        <div class="toggle-switch" id="notifToggle" onclick="toggleNotifications()">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div id="notifStatus" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      <div class="divider"></div>
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:8px;" data-i18n="alertTiming">Alert timing</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;" id="alertTiming">
        <button class="btn sm active" data-days="1" data-i18n="day1Before">1 day before</button>
        <button class="btn sm" data-days="3" data-i18n="day3Before">3 days before</button>
        <button class="btn sm" data-days="7" data-i18n="week1Before">1 week before</button>
      </div>
      <div class="divider"></div>
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:8px;" data-i18n="notifyFor">Notify for aspects</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;" id="alertAspects">
        <button class="btn sm active" data-asp="Conjunction" data-i18n="aspConj">Conjunction</button>
        <button class="btn sm active" data-asp="Opposition" data-i18n="aspOpp">Opposition</button>
        <button class="btn sm active" data-asp="Trine" data-i18n="aspTrine">Trine</button>
        <button class="btn sm active" data-asp="Square" data-i18n="aspSquare">Square</button>
        <button class="btn sm" data-asp="Sextile" data-i18n="aspSext">Sextile</button>
      </div>
      <div class="divider"></div>
      <button class="btn primary" style="width:100%;" id="scheduleNotifBtn" onclick="scheduleTransitNotifications()" data-i18n="scheduleNotif">Schedule Notifications</button>
    </div>
  </div>

  <!-- Appearance -->
  <div class="card">
    <div class="card-header"><span class="card-title">ğŸ¨ <span data-i18n="appearance">Appearance</span></span></div>
    <div class="card-body">
      <div class="notif-toggle">
        <div>
          <div class="notif-label" data-i18n="lightMode">Light Mode</div>
          <div class="notif-desc" data-i18n="lightModeDesc">Switch between dark and light theme</div>
        </div>
        <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()">
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Orb settings -->
  <div class="card">
    <div class="card-header"><span class="card-title">âš™ <span data-i18n="transitOrbs">Transit Orbs</span></span></div>
    <div class="card-body">
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;" data-i18n="orbDesc">
        Orb (degrees of tolerance) used when detecting transits
      </div>
      <div class="input-row">
        <div class="field"><label data-i18n="majorOrb">Major aspects (Â°)</label><input class="input" type="number" id="orbMajor" value="3" min="1" max="10" style="width:100%;"></div>
        <div class="field"><label data-i18n="minorOrb">Minor aspects (Â°)</label><input class="input" type="number" id="orbMinor" value="1" min="1" max="5" style="width:100%;"></div>
      </div>
    </div>
  </div>

  <!-- About -->
  <div class="card">
    <div class="card-header"><span class="card-title">â„¹ <span data-i18n="about">About</span></span></div>
    <div class="card-body">
      <div style="font-size:12px;color:var(--muted);line-height:1.7;">
        <strong style="color:var(--accent)">WrÃ³Å¼AI</strong> <span data-i18n="aboutText">uses the Swiss Ephemeris engine (Astrodienst AG) for sub-arcminute planetary calculations. All data is calculated locally on your device â€” no data is sent to any server. Tropical zodiac (Aries = 0Â° at vernal equinox). Houses: Placidus system.</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import SwissEph from 'https://cdn.jsdelivr.net/gh/prolaxu/swisseph-wasm@main/src/swisseph.js';

const DEG=Math.PI/180, RAD=180/Math.PI;
const norm=d=>((d%360)+360)%360;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INTERNATIONALISATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TRANSLATIONS={
  en:{
    loading:'Loading Swiss Ephemerisâ€¦',
    addProfile:'Add Birth Profile',name:'Name',birthDate:'Birth Date',
    birthTime:'Birth Time',birthPlace:'Birth Place',
    birthPlaceHint:'Enter city for house calculation (Ascendant)',
    saveProfile:'Save Profile',cancel:'Cancel',
    navSky:'Sky Now',navProfiles:'Profiles',navTransits:'Transits',navSettings:'Settings',
    appSubtitle:'Astrological Clock Â· Swiss Ephemeris',
    installTitle:'Install as App',
    installAndroid:'Android: tap â‹® menu â†’ "Add to Home screen"',
    installIphone:'iPhone: tap Share â†’ "Add to Home Screen"',
    wheelTitle:'Zodiac Wheel Â· Current Sky',live:'LIVE',historical:'HISTORICAL',
    timeNav:'â± Time Navigation',historicalMode:'HISTORICAL MODE',
    week:'Week',day:'Day',hr:'Hr',jump:'Jump â†µ',now:'âŸ³ Now',
    animation:'Animation:',play:'â–¶ Play',pause:'â¸ Pause',
    planetPos:'Planet Positions',planet:'Planet',sign:'Sign',degrees:'Degrees',house:'House',
    profilesSubtitle:'Birth charts & natal data',addProfileBtn:'+ Add Profile',
    noProfiles:'No birth profiles yet.\nAdd your first profile to track personal transits.',
    natalChart:'Natal Chart',
    transitsSubtitle:'Upcoming planetary aspects to natal positions',
    profile:'Profile',selectProfile:'Select whose transits to show',
    selectProfileOpt:'â€” Select Profile â€”',lookAhead:'Look ahead',searchWindow:'Search window',
    days:'days',year:'year',calcTransits:'Calculate Transits',
    transitEmpty:'Select a birth profile and calculate to see upcoming transits.',
    language:'Language',pushNotif:'Push Notifications',transitAlerts:'Transit Alerts',
    transitAlertsDesc:'Notify me of major upcoming transits',alertTiming:'Alert timing',
    day1Before:'1 day before',day3Before:'3 days before',week1Before:'1 week before',
    notifyFor:'Notify for aspects',
    aspConj:'Conjunction',aspOpp:'Opposition',aspTrine:'Trine',aspSquare:'Square',aspSext:'Sextile',
    scheduleNotif:'Schedule Notifications',appearance:'Appearance',lightMode:'Light Mode',
    lightModeDesc:'Switch between dark and light theme',transitOrbs:'Transit Orbs',
    orbDesc:'Orb (degrees of tolerance) used when detecting transits',
    majorOrb:'Major aspects (Â°)',minorOrb:'Minor aspects (Â°)',about:'About',
    aboutText:'uses the Swiss Ephemeris engine (Astrodienst AG) for sub-arcminute planetary calculations. All data is calculated locally on your device â€” no data is sent to any server. Tropical zodiac (Aries = 0Â° at vernal equinox). Houses: Placidus system.',
    settingsSubtitle:'Preferences & notifications',
    natalToday:'today',natalAgo:'d ago',natalIn:'d',
    geocodeError:'Could not find city. Chart drawn without houses.',
    houseSystem:'Placidus houses Â· ASC',ascendant:'ASC',mc:'MC',
    natalFor:'transits found for',
  },
  pl:{
    loading:'Åadowanie Swiss Ephemerisâ€¦',
    addProfile:'Dodaj profil urodzin',name:'ImiÄ™',birthDate:'Data urodzin',
    birthTime:'Godzina urodzin',birthPlace:'Miejsce urodzin',
    birthPlaceHint:'Podaj miasto dla obliczenia domÃ³w (Ascendent)',
    saveProfile:'Zapisz profil',cancel:'Anuluj',
    navSky:'Niebo Teraz',navProfiles:'Profile',navTransits:'Tranzyty',navSettings:'Ustawienia',
    appSubtitle:'Zegar Astrologiczny Â· Swiss Ephemeris',
    installTitle:'Zainstaluj jako aplikacjÄ™',
    installAndroid:'Android: dotknij â‹® menu â†’ "Dodaj do ekranu gÅ‚Ã³wnego"',
    installIphone:'iPhone: dotknij UdostÄ™pnij â†’ "Dodaj do ekranu gÅ‚Ã³wnego"',
    wheelTitle:'KoÅ‚o Zodiaku Â· Niebo Teraz',live:'NA Å»YWO',historical:'HISTORYCZNY',
    timeNav:'â± Nawigacja Czasowa',historicalMode:'TRYB HISTORYCZNY',
    week:'TydzieÅ„',day:'DzieÅ„',hr:'Godz',jump:'Skocz â†µ',now:'âŸ³ Teraz',
    animation:'Animacja:',play:'â–¶ OdtwÃ³rz',pause:'â¸ Pauza',
    planetPos:'Pozycje Planet',planet:'Planeta',sign:'Znak',degrees:'Stopnie',house:'Dom',
    profilesSubtitle:'Horoskopy urodzin i dane natalne',addProfileBtn:'+ Dodaj profil',
    noProfiles:'Brak profili urodzin.\nDodaj swÃ³j pierwszy profil, aby Å›ledziÄ‡ osobiste tranzyty.',
    natalChart:'Mapa urodzin',
    transitsSubtitle:'NadchodzÄ…ce aspekty planet do pozycji natalnych',
    profile:'Profil',selectProfile:'Wybierz czyje tranzyty pokazaÄ‡',
    selectProfileOpt:'â€” Wybierz profil â€”',lookAhead:'Szukaj do przodu',searchWindow:'Okno wyszukiwania',
    days:'dni',year:'rok',calcTransits:'Oblicz Tranzyty',
    transitEmpty:'Wybierz profil i oblicz, aby zobaczyÄ‡ nadchodzÄ…ce tranzyty.',
    language:'JÄ™zyk',pushNotif:'Powiadomienia Push',transitAlerts:'Alerty TranzytÃ³w',
    transitAlertsDesc:'Powiadamiaj mnie o waÅ¼nych nadchodzÄ…cych tranzytach',alertTiming:'Czas alertu',
    day1Before:'1 dzieÅ„ wczeÅ›niej',day3Before:'3 dni wczeÅ›niej',week1Before:'1 tydzieÅ„ wczeÅ›niej',
    notifyFor:'Powiadamiaj dla aspektÃ³w',
    aspConj:'Koniunkcja',aspOpp:'Opozycja',aspTrine:'Trygon',aspSquare:'Kwadratura',aspSext:'Sekstyl',
    scheduleNotif:'Zaplanuj Powiadomienia',appearance:'WyglÄ…d',lightMode:'Tryb Jasny',
    lightModeDesc:'PrzeÅ‚Ä…cz miÄ™dzy trybem ciemnym a jasnym',transitOrbs:'Orby TranzytÃ³w',
    orbDesc:'Orb (tolerancja w stopniach) uÅ¼ywany przy wykrywaniu tranzytÃ³w',
    majorOrb:'Aspekty gÅ‚Ã³wne (Â°)',minorOrb:'Aspekty mniejsze (Â°)',about:'O aplikacji',
    aboutText:'uÅ¼ywa silnika Swiss Ephemeris (Astrodienst AG) do obliczeÅ„ planetarnych z dokÅ‚adnoÅ›ciÄ… sub-minutowÄ…. Wszystkie dane sÄ… obliczane lokalnie na Twoim urzÄ…dzeniu â€” Å¼adne dane nie sÄ… wysyÅ‚ane na serwer. Zodiak tropikalny (Baran = 0Â° w rÃ³wnonocy wiosennej). Domy: system Placidusa.',
    settingsSubtitle:'Preferencje i powiadomienia',
    natalToday:'dzisiaj',natalAgo:'d temu',natalIn:'d',
    geocodeError:'Nie znaleziono miasta. Mapa bez domÃ³w.',
    houseSystem:'Domy Placidusa Â· ASC',ascendant:'ASC',mc:'MC',
    natalFor:'tranzytÃ³w znaleziono dla',
  }
};

let currentLang='en';
function t(key){return TRANSLATIONS[currentLang][key]||TRANSLATIONS.en[key]||key;}

window.setLang=function(lang){
  currentLang=lang;
  localStorage.setItem('wrozai_lang',lang);
  document.getElementById('langEN').classList.toggle('active',lang==='en');
  document.getElementById('langPL').classList.toggle('active',lang==='pl');
  applyTranslations();
  render(currentDate);
  if(selectedProfileId) redrawNatal(selectedProfileId);
};

function applyTranslations(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{
    const key=el.getAttribute('data-i18n');
    const txt=t(key);
    if(txt) el.textContent=txt;
  });
  document.getElementById('liveLabel').textContent=isLive?t('live'):t('historical');
  if(document.getElementById('animBtn').classList.contains('active')){
    document.getElementById('animBtn').textContent=t('pause');
  } else {
    document.getElementById('animBtn').textContent=t('play');
  }
}

// â”€â”€ ZODIAC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SIGNS_EN=['Aries','Taurus','Gemini','Cancer','Leo','Virgo','Libra','Scorpio','Sagittarius','Capricorn','Aquarius','Pisces'];
const SIGNS_PL=['Baran','Byk','BliÅºniÄ™ta','Rak','Lew','Panna','Waga','Skorpion','Strzelec','KozioroÅ¼ec','Wodnik','Ryby'];
const SIGN_SYMS=['â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“'];
const SIGN_COLORS=['#c0392b','#27ae60','#c8961a','#2980b9','#d35400','#16a085','#8e44ad','#922b21','#ca6f1e','#566573','#1a5276','#6c3483'];
function signOf(lon){
  const idx=Math.floor(norm(lon)/30);
  const d=norm(lon)%30,dg=Math.floor(d),mn=Math.floor((d-dg)*60);
  const names=currentLang==='pl'?SIGNS_PL:SIGNS_EN;
  return{name:names[idx],sym:SIGN_SYMS[idx],color:SIGN_COLORS[idx],idx,deg:dg,min:mn};
}

// â”€â”€ PLANETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PLANETS_EN=['Sun','Moon','Mercury','Venus','Mars','Jupiter','Saturn','Uranus','Neptune','Pluto','N. Node','S. Node'];
const PLANETS_PL=['SÅ‚oÅ„ce','KsiÄ™Å¼yc','Merkury','Wenus','Mars','Jowisz','Saturn','Uran','Neptun','Pluton','WÄ™zeÅ‚ Pn.','WÄ™zeÅ‚ Pd.'];
const PLANET_SYMS=['â˜‰','â˜½','â˜¿','â™€','â™‚','â™ƒ','â™„','â›¢','â™†','â™‡','â˜Š','â˜‹'];
const PLANET_COLORS=['#c47c0a','#2471a3','#707b8a','#1e8449','#c0392b','#9a6b00','#7d6608','#0e7490','#1a3a7e','#6d4c41','#9b7200','#9b7200'];
const PLANET_SWE_IDS=[0,1,2,3,4,5,6,7,8,9,11,11];
const PLANET_IS_NODE=[false,false,false,false,false,false,false,false,false,false,true,true];
const PLANET_IS_SOUTH=[false,false,false,false,false,false,false,false,false,false,false,true];

function pName(i){return(currentLang==='pl'?PLANETS_PL:PLANETS_EN)[i];}
const TRANSIT_PLANET_IDXS=[0,1,2,3,4,5,6,7,8,9];

// â”€â”€ SWISS EPHEMERIS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sweEngine=null;
async function initSwe(){
  const swe=new SwissEph();
  await swe.initSwissEph();
  sweEngine=swe;
}
function calcData(dateObj){
  if(!sweEngine) return Array(12).fill(null);
  const jd=sweEngine.julday(
    dateObj.getUTCFullYear(),dateObj.getUTCMonth()+1,dateObj.getUTCDate(),
    dateObj.getUTCHours()+dateObj.getUTCMinutes()/60+dateObj.getUTCSeconds()/3600
  );
  const FLAG=(sweEngine.SEFLG_SWIEPH||2)|(sweEngine.SEFLG_SPEED||256);
  return PLANET_SWE_IDS.map((sweId,i)=>{
    try{
      const r=sweEngine.calc_ut(jd,sweId,FLAG);
      let lon=norm(r[0]);
      if(PLANET_IS_SOUTH[i]) lon=norm(lon+180);
      return{lon,retrograde:PLANET_IS_SOUTH[i]?true:r[3]<0};
    }catch(e){return null;}
  });
}

// â”€â”€ HOUSE CALCULATION (Placidus) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Uses the ARMC / obliquity method to compute Placidus house cusps
// Returns {cusps:[12], asc, mc, dc, ic} all in ecliptic longitude degrees
function calcHouses(jd, lat, lon){
  if(!sweEngine) return null;
  try{
    // sweEngine.houses_ex returns [cusps(13), ascmc(10)]
    // cusps[1..12] = house cusps, ascmc[0]=ASC, ascmc[1]=MC
    const result=sweEngine.houses_ex(jd, 0, lat, lon, 'P'); // P = Placidus
    if(!result) return null;
    const cusps=result[0]; // array 0..12, cusps[1..12] are the 12 house cusps
    const ascmc=result[1];
    return{
      cusps: Array.from({length:12},(v,i)=>norm(cusps[i+1])),
      asc:norm(ascmc[0]),
      mc:norm(ascmc[1]),
      dc:norm(ascmc[0]+180),
      ic:norm(ascmc[1]+180),
    };
  }catch(e){
    // Fallback: try whole-sign from solar longitude
    return null;
  }
}

// Which house does a planet fall in (1-12)?
function whichHouse(lon, cusps){
  if(!cusps) return null;
  for(let h=0;h<12;h++){
    const start=cusps[h];
    const end=cusps[(h+1)%12];
    if(start<=end){
      if(lon>=start&&lon<end) return h+1;
    } else {
      if(lon>=start||lon<end) return h+1;
    }
  }
  return 1;
}

// â”€â”€ GEOCODING using Open-Meteo/Nominatim â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function geocodeCity(cityName){
  try{
    const url=`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(cityName)}&format=json&limit=1`;
    const resp=await fetch(url,{headers:{'Accept-Language':'en'}});
    const data=await resp.json();
    if(data&&data.length>0){
      return{lat:parseFloat(data[0].lat),lon:parseFloat(data[0].lon),name:data[0].display_name};
    }
  }catch(e){}
  return null;
}

// â”€â”€ MOON PHASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MOON_NAMES_EN=['New Moon','Waxing Crescent','First Quarter','Waxing Gibbous','Full Moon','Waning Gibbous','Last Quarter','Waning Crescent'];
const MOON_NAMES_PL=['NÃ³w','PrzybywajÄ…cy Sierp','Pierwsza Kwadra','PrzybywajÄ…cy Garb','PeÅ‚nia','UbywajÄ…cy Garb','Ostatnia Kwadra','UbywajÄ…cy Sierp'];
const MOON_EMOJIS=['ğŸŒ‘','ğŸŒ’','ğŸŒ“','ğŸŒ”','ğŸŒ•','ğŸŒ–','ğŸŒ—','ğŸŒ˜'];
function moonPhase(data){
  const sl=data[0]?.lon,ml=data[1]?.lon;
  if(sl==null||ml==null) return null;
  const a=norm(ml-sl);
  const idx=Math.floor(a/45);
  const names=currentLang==='pl'?MOON_NAMES_PL:MOON_NAMES_EN;
  return{name:names[idx],emoji:MOON_EMOJIS[idx],illum:Math.round((1-Math.cos(a*DEG))/2*100)};
}

// â”€â”€ ASPECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ASPECT_DEFS=[
  {key:'aspConj', angle:0,  orb:8, color:'rgba(100,100,200,0.55)',dash:'',    width:1.5, cls:'conj',sym:'â˜Œ'},
  {key:'aspOpp',  angle:180,orb:8, color:'rgba(180,40,40,0.55)',  dash:'',    width:1.5, cls:'opp', sym:'â˜'},
  {key:'aspTrine',angle:120,orb:7, color:'rgba(40,160,80,0.55)',  dash:'',    width:1.4, cls:'trine',sym:'â–³'},
  {key:'aspSquare',angle:90,orb:7, color:'rgba(200,50,50,0.50)',  dash:'5,3', width:1.3, cls:'square',sym:'â–¡'},
  {key:'aspSext', angle:60, orb:5, color:'rgba(40,120,200,0.50)', dash:'3,2', width:1.2, cls:'sext',sym:'âš¹'},
  {key:'Semisquare',angle:45,orb:2,color:'rgba(180,100,40,0.40)',dash:'2,3', width:0.9, cls:'sext',sym:'âˆ '},
  {key:'Quincunx',angle:150,orb:2, color:'rgba(160,40,160,0.40)',dash:'4,3', width:0.9, cls:'sext',sym:'âš»'},
];
function aspName(def){
  const tr={aspConj:'Conjunction',aspOpp:'Opposition',aspTrine:'Trine',aspSquare:'Square',aspSext:'Sextile',Semisquare:'Semisquare',Quincunx:'Quincunx'};
  const trPL={aspConj:'Koniunkcja',aspOpp:'Opozycja',aspTrine:'Trygon',aspSquare:'Kwadratura',aspSext:'Sekstyl',Semisquare:'PÃ³Å‚kwadrat',Quincunx:'KwinkuÅ„ks'};
  return(currentLang==='pl'?trPL:tr)[def.key]||def.key;
}
function calcAspects(data){
  const aspects=[];
  for(let i=0;i<data.length;i++){
    if(!data[i]||PLANET_IS_NODE[i]) continue;
    for(let j=i+1;j<data.length;j++){
      if(!data[j]||PLANET_IS_NODE[j]) continue;
      let diff=Math.abs(data[i].lon-data[j].lon);
      if(diff>180) diff=360-diff;
      for(const asp of ASPECT_DEFS){
        if(Math.abs(diff-asp.angle)<=asp.orb){aspects.push({p1:i,p2:j,asp});break;}
      }
    }
  }
  return aspects;
}

// â”€â”€ DRAW WHEEL (Current Sky â€” Aries on left, no houses) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawWheel(data, svgId='horoscope-wheel'){
  const svg=document.getElementById(svgId);
  if(!svg) return;
  const cx=260,cy=260,rO=244,rB=208,rI=172;
  svg.innerHTML='';
  const ns='http://www.w3.org/2000/svg';
  const mk=(tag,attrs,txt)=>{const e=document.createElementNS(ns,tag);for(const[k,v]of Object.entries(attrs))e.setAttribute(k,v);if(txt!==undefined)e.textContent=txt;return e;};
  const dark=!document.body.classList.contains('light');

  // Background
  const defs=mk('defs',{});
  const gr=mk('radialGradient',{id:`bg${svgId}`,cx:'50%',cy:'50%',r:'50%'});
  gr.appendChild(mk('stop',{offset:'0%','stop-color':dark?'#131c32':'#eef2fb'}));
  gr.appendChild(mk('stop',{offset:'100%','stop-color':dark?'#0a1020':'#dde4f5'}));
  defs.appendChild(gr); svg.appendChild(defs);
  svg.appendChild(mk('circle',{cx,cy,r:rO,fill:`url(#bg${svgId})`,stroke:dark?'#1e2d4a':'#b0bcd8','stroke-width':'1.5'}));

  // Sign sectors (Aries left = 180Â° in SVG space)
  for(let i=0;i<12;i++){
    const a1=(180-i*30)*DEG,a2=(180-(i+1)*30)*DEG;
    const x1=cx+rB*Math.cos(a1),y1=cy+rB*Math.sin(a1);
    const x2=cx+rO*Math.cos(a1),y2=cy+rO*Math.sin(a1);
    const x3=cx+rO*Math.cos(a2),y3=cy+rO*Math.sin(a2);
    const x4=cx+rB*Math.cos(a2),y4=cy+rB*Math.sin(a2);
    svg.appendChild(mk('path',{d:`M ${x1} ${y1} L ${x2} ${y2} A ${rO} ${rO} 0 0 1 ${x3} ${y3} L ${x4} ${y4} A ${rB} ${rB} 0 0 0 ${x1} ${y1}`,fill:SIGN_COLORS[i]+'22',stroke:dark?'#1e2d4a':'#b8c4dc','stroke-width':'0.5'}));
    const ma=(180-(i+0.5)*30)*DEG,rs=(rB+rO)/2;
    svg.appendChild(mk('text',{x:cx+rs*Math.cos(ma),y:cy+rs*Math.sin(ma),'text-anchor':'middle','dominant-baseline':'central',fill:SIGN_COLORS[i],'font-size':'18','font-weight':'bold','font-family':'serif'},SIGN_SYMS[i]));
  }
  svg.appendChild(mk('circle',{cx,cy,r:rB,fill:'none',stroke:dark?'#1e2d4a':'#a8b8d8','stroke-width':'1.2'}));
  svg.appendChild(mk('circle',{cx,cy,r:rI,fill:dark?'#0d1626':'#f8faff',stroke:dark?'#182436':'#b8c8e0','stroke-width':'1'}));

  // Degree ticks
  for(let i=0;i<360;i+=5){
    const a=(180-i)*DEG,r1=i%30===0?rI-14:i%10===0?rI-8:rI-4;
    svg.appendChild(mk('line',{x1:cx+rI*Math.cos(a),y1:cy+rI*Math.sin(a),x2:cx+r1*Math.cos(a),y2:cy+r1*Math.sin(a),stroke:i%30===0?(dark?'#4060a0':'#6070a0'):(dark?'#1e2d4a':'#b0bcd8'),'stroke-width':i%30===0?'1.4':'0.6'}));
  }
  // Sign dividers (FIXED: both endpoints use sin/cos correctly)
  for(let i=0;i<12;i++){
    const a=(180-i*30)*DEG;
    svg.appendChild(mk('line',{x1:cx+rI*Math.cos(a),y1:cy+rI*Math.sin(a),x2:cx+rB*Math.cos(a),y2:cy+rB*Math.sin(a),stroke:dark?'#2a3d60':'#8898c0','stroke-width':'0.9'}));
  }

  // Aspect lines
  const aspects=calcAspects(data);
  const rAsp=rI-4;
  aspects.forEach(({p1,p2,asp})=>{
    if(!data[p1]||!data[p2]) return;
    const a1=(180-data[p1].lon)*DEG,a2=(180-data[p2].lon)*DEG;
    const ln=mk('line',{x1:cx+rAsp*Math.cos(a1),y1:cy+rAsp*Math.sin(a1),x2:cx+rAsp*Math.cos(a2),y2:cy+rAsp*Math.sin(a2),stroke:asp.color,'stroke-width':String(asp.width)});
    if(asp.dash) ln.setAttribute('stroke-dasharray',asp.dash);
    svg.appendChild(ln);
  });

  // Moon center
  const phase=moonPhase(data);
  svg.appendChild(mk('circle',{cx,cy,r:30,fill:dark?'#0d1626':'#e8eef8',stroke:dark?'#1e2d4a':'#c0cce0','stroke-width':'1'}));
  if(phase){
    svg.appendChild(mk('text',{x:cx,y:cy-8,'text-anchor':'middle','dominant-baseline':'central','font-size':'20'},phase.emoji));
    svg.appendChild(mk('text',{x:cx,y:cy+12,'text-anchor':'middle','dominant-baseline':'central',fill:dark?'#6080b0':'#4a5a80','font-size':'8','font-weight':'600','font-family':'Raleway,sans-serif'},`${phase.illum}%`));
  }

  // Planet symbols
  data.forEach((p,idx)=>{
    if(!p) return;
    const angle=(180-p.lon)*DEG;
    const dotX=cx+rI*Math.cos(angle),dotY=cy+rI*Math.sin(angle);
    const hit=mk('circle',{cx:dotX,cy:dotY,r:'13',fill:'transparent','pointer-events':'all',cursor:'pointer'});
    const dot=mk('text',{x:dotX,y:dotY,'text-anchor':'middle','dominant-baseline':'central',fill:PLANET_COLORS[idx],'font-size':PLANET_IS_NODE[idx]?'18':'16','font-family':'serif','font-weight':'bold','pointer-events':'none','filter':'drop-shadow(0 1px 2px rgba(0,0,0,0.4))'},PLANET_SYMS[idx]);
    const s=signOf(p.lon);
    const degMin=`${s.deg}Â°${String(s.min).padStart(2,'0')}'`;
    const showTip=(e,touch)=>{
      const tip=document.getElementById('planetTooltip');
      tip.querySelector('.tip-sym').textContent=PLANET_SYMS[idx];
      tip.querySelector('.tip-sym').style.color=PLANET_COLORS[idx];
      tip.querySelector('.tip-name').textContent=pName(idx)+' Â· '+s.name;
      tip.querySelector('.tip-deg').textContent=degMin;
      tip.style.display='flex';
      const rect=svg.getBoundingClientRect();
      const scaleX=rect.width/520,scaleY=rect.height/520;
      const px=rect.left+dotX*scaleX,py=rect.top+dotY*scaleY;
      tip.style.left=px+'px';
      tip.style.top=(dotY>260?py-46:py+16)+'px';
      tip.style.transform='translateX(-50%)';
      if(touch) setTimeout(()=>tip.style.display='none',2500);
    };
    hit.addEventListener('mouseenter',showTip);
    hit.addEventListener('mouseleave',()=>document.getElementById('planetTooltip').style.display='none');
    hit.addEventListener('touchstart',(e)=>{e.preventDefault();showTip(e,true);});
    svg.appendChild(hit);
    svg.appendChild(dot);
  });
  svg.appendChild(mk('circle',{cx,cy,r:rO,fill:'none',stroke:dark?'#2a3d60':'#8898c0','stroke-width':'1.5'}));
}

// â”€â”€ DRAW NATAL WHEEL (ASC-based, with houses) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawNatalWheel(data, houses, svgId='natal-wheel'){
  const svg=document.getElementById(svgId);
  if(!svg) return;
  const cx=260,cy=260,rO=244,rB=208,rI=172,rH=140;
  svg.innerHTML='';
  const ns='http://www.w3.org/2000/svg';
  const mk=(tag,attrs,txt)=>{const e=document.createElementNS(ns,tag);for(const[k,v]of Object.entries(attrs))e.setAttribute(k,v);if(txt!==undefined)e.textContent=txt;return e;};
  const dark=!document.body.classList.contains('light');

  // If no house data, fall back to standard wheel
  if(!houses){drawWheel(data,svgId);return;}

  const asc=houses.asc; // degrees in ecliptic
  // In natal chart, ASC goes on the LEFT (180Â° in SVG)
  // Rotation offset: SVG left = 180Â°, so angle = 180 - (lon - asc)
  const svgAngle=(lon)=>(180-(lon-asc))*DEG;

  // Background
  const defs=mk('defs',{});
  const gr=mk('radialGradient',{id:`bg${svgId}`,cx:'50%',cy:'50%',r:'50%'});
  gr.appendChild(mk('stop',{offset:'0%','stop-color':dark?'#0f1828':'#f0f4ff'}));
  gr.appendChild(mk('stop',{offset:'100%','stop-color':dark?'#080e1a':'#e0e8f8'}));
  defs.appendChild(gr); svg.appendChild(defs);
  svg.appendChild(mk('circle',{cx,cy,r:rO,fill:`url(#bg${svgId})`,stroke:dark?'#1e2d4a':'#b0bcd8','stroke-width':'1.5'}));

  // Sign sectors â€” rotated by ASC
  for(let i=0;i<12;i++){
    const signStartLon=i*30;
    const a1=svgAngle(signStartLon),a2=svgAngle(signStartLon+30);
    // Draw arc sector
    const x1=cx+rB*Math.cos(a1),y1=cy+rB*Math.sin(a1);
    const x2=cx+rO*Math.cos(a1),y2=cy+rO*Math.sin(a1);
    const x3=cx+rO*Math.cos(a2),y3=cy+rO*Math.sin(a2);
    const x4=cx+rB*Math.cos(a2),y4=cy+rB*Math.sin(a2);
    // determine sweep direction: going clockwise in SVG = decreasing lon
    const large=0;
    svg.appendChild(mk('path',{d:`M ${x1} ${y1} L ${x2} ${y2} A ${rO} ${rO} 0 0 0 ${x3} ${y3} L ${x4} ${y4} A ${rB} ${rB} 0 0 1 ${x1} ${y1}`,fill:SIGN_COLORS[i]+'22',stroke:dark?'#1e2d4a':'#b8c4dc','stroke-width':'0.5'}));
    const ma=svgAngle(signStartLon+15),rs=(rB+rO)/2;
    svg.appendChild(mk('text',{x:cx+rs*Math.cos(ma),y:cy+rs*Math.sin(ma),'text-anchor':'middle','dominant-baseline':'central',fill:SIGN_COLORS[i],'font-size':'16','font-weight':'bold','font-family':'serif'},SIGN_SYMS[i]));
  }

  svg.appendChild(mk('circle',{cx,cy,r:rB,fill:'none',stroke:dark?'#1e2d4a':'#a8b8d8','stroke-width':'1.2'}));
  svg.appendChild(mk('circle',{cx,cy,r:rI,fill:dark?'#0b1420':'#f6f9ff',stroke:dark?'#182436':'#b8c8e0','stroke-width':'1'}));
  svg.appendChild(mk('circle',{cx,cy,r:rH,fill:'none',stroke:dark?'#162030':'#c8d8f0','stroke-width':'0.6','stroke-dasharray':'2,4'}));

  // House cusps
  houses.cusps.forEach((cusp,h)=>{
    const a=svgAngle(cusp);
    const isAngular=[0,3,6,9].includes(h);
    const r_inner=isAngular?30:rH;
    const sw=isAngular?'1.8':'0.8';
    const col=isAngular?(dark?'#c8a040':'#9a7020'):( dark?'#2a3d60':'#9ab0cc');
    svg.appendChild(mk('line',{x1:cx+r_inner*Math.cos(a),y1:cy+r_inner*Math.sin(a),x2:cx+rI*Math.cos(a),y2:cy+rI*Math.sin(a),stroke:col,'stroke-width':sw}));
    // House number label
    const nextCusp=houses.cusps[(h+1)%12];
    const midLon=(cusp+nextCusp)/2+(nextCusp<cusp?180:0);
    const midA=svgAngle(cusp + (norm(nextCusp-cusp+360))/2);
    const rLabel=(rH+rI)/2;
    svg.appendChild(mk('text',{x:cx+rLabel*Math.cos(midA),y:cy+rLabel*Math.sin(midA),'text-anchor':'middle','dominant-baseline':'central',fill:dark?'#4060a0':'#8090b8','font-size':'10','font-family':'Raleway,sans-serif','font-weight':'700'},String(h+1)));
  });

  // Angle labels ASC, DC, MC, IC
  const angles=[
    {lon:houses.asc,label:t('ascendant')},
    {lon:houses.dc, label:'DC'},
    {lon:houses.mc, label:t('mc')},
    {lon:houses.ic, label:'IC'},
  ];
  angles.forEach(({lon,label})=>{
    const a=svgAngle(lon);
    const r_txt=rO-12;
    svg.appendChild(mk('text',{x:cx+r_txt*Math.cos(a),y:cy+r_txt*Math.sin(a),'text-anchor':'middle','dominant-baseline':'central',fill:dark?'#e8c060':'#9a7020','font-size':'9','font-weight':'800','font-family':'Raleway,sans-serif'},label));
  });

  // Degree ticks on rI ring
  for(let i=0;i<360;i+=5){
    const a=svgAngle(i);
    const r1=i%30===0?rI-12:i%10===0?rI-7:rI-4;
    svg.appendChild(mk('line',{x1:cx+rI*Math.cos(a),y1:cy+rI*Math.sin(a),x2:cx+r1*Math.cos(a),y2:cy+r1*Math.sin(a),stroke:dark?'#1e2d4a':'#b0bcd8','stroke-width':'0.5'}));
  }

  // Aspect lines
  const rAsp=rH-6;
  const aspects=calcAspects(data);
  aspects.forEach(({p1,p2,asp})=>{
    if(!data[p1]||!data[p2]) return;
    const a1=svgAngle(data[p1].lon),a2=svgAngle(data[p2].lon);
    const ln=mk('line',{x1:cx+rAsp*Math.cos(a1),y1:cy+rAsp*Math.sin(a1),x2:cx+rAsp*Math.cos(a2),y2:cy+rAsp*Math.sin(a2),stroke:asp.color,'stroke-width':String(asp.width)});
    if(asp.dash) ln.setAttribute('stroke-dasharray',asp.dash);
    svg.appendChild(ln);
  });

  // Center
  const phase=moonPhase(data);
  svg.appendChild(mk('circle',{cx,cy,r:28,fill:dark?'#0b1420':'#eef4ff',stroke:dark?'#1e2d4a':'#c0cce0','stroke-width':'1'}));
  if(phase){
    svg.appendChild(mk('text',{x:cx,y:cy-7,'text-anchor':'middle','dominant-baseline':'central','font-size':'18'},phase.emoji));
    svg.appendChild(mk('text',{x:cx,y:cy+11,'text-anchor':'middle','dominant-baseline':'central',fill:dark?'#6080b0':'#4a5a80','font-size':'8','font-weight':'600','font-family':'Raleway,sans-serif'},`${phase.illum}%`));
  }

  // Planet symbols
  data.forEach((p,idx)=>{
    if(!p) return;
    const angle=svgAngle(p.lon);
    const dotX=cx+rI*Math.cos(angle),dotY=cy+rI*Math.sin(angle);
    const hit=mk('circle',{cx:dotX,cy:dotY,r:'13',fill:'transparent','pointer-events':'all',cursor:'pointer'});
    const houseNum=whichHouse(p.lon,houses.cusps);
    const dot=mk('text',{x:dotX,y:dotY,'text-anchor':'middle','dominant-baseline':'central',fill:PLANET_COLORS[idx],'font-size':PLANET_IS_NODE[idx]?'18':'16','font-family':'serif','font-weight':'bold','pointer-events':'none','filter':'drop-shadow(0 1px 2px rgba(0,0,0,0.4))'},PLANET_SYMS[idx]);
    const s=signOf(p.lon);
    const showTip=(e,touch)=>{
      const tip=document.getElementById('planetTooltip');
      tip.querySelector('.tip-sym').textContent=PLANET_SYMS[idx];
      tip.querySelector('.tip-sym').style.color=PLANET_COLORS[idx];
      tip.querySelector('.tip-name').textContent=pName(idx)+' Â· '+s.name+(houseNum?' Â· H'+houseNum:'');
      tip.querySelector('.tip-deg').textContent=`${s.deg}Â°${String(s.min).padStart(2,'0')}'`;
      tip.style.display='flex';
      const rect=svg.getBoundingClientRect();
      const scaleX=rect.width/520,scaleY=rect.height/520;
      const px=rect.left+dotX*scaleX,py=rect.top+dotY*scaleY;
      tip.style.left=px+'px';
      tip.style.top=(dotY>260?py-46:py+16)+'px';
      tip.style.transform='translateX(-50%)';
      if(touch) setTimeout(()=>tip.style.display='none',2500);
    };
    hit.addEventListener('mouseenter',showTip);
    hit.addEventListener('mouseleave',()=>document.getElementById('planetTooltip').style.display='none');
    hit.addEventListener('touchstart',(e)=>{e.preventDefault();showTip(e,true);});
    svg.appendChild(hit);
    svg.appendChild(dot);
  });
  svg.appendChild(mk('circle',{cx,cy,r:rO,fill:'none',stroke:dark?'#2a3d60':'#8898c0','stroke-width':'1.5'}));
}

// â”€â”€ PLANET TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderList(data, tbodyId='planet-tbody', houses=null){
  const tbody=document.getElementById(tbodyId);
  if(!tbody) return;
  tbody.innerHTML='';
  data.forEach((p,i)=>{
    if(!p) return;
    const s=signOf(p.lon),ms=String(s.min).padStart(2,'0');
    const houseNum=houses?whichHouse(p.lon,houses.cusps):null;
    const tr=document.createElement('tr');
    tr.className='fade-in';
    tr.style.animationDelay=(i*0.04)+'s';
    tr.innerHTML=`
      <td class="td-sym"><span style="color:${PLANET_COLORS[i]}">${PLANET_SYMS[i]}</span></td>
      <td class="td-name">${pName(i)}</td>
      <td><div class="td-sign"><span class="sign-sym" style="color:${s.color}">${s.sym}</span><span class="sign-nm">${s.name}</span></div></td>
      <td style="font-size:11px;color:var(--gold);font-weight:700;">${houseNum?'H'+houseNum:''}</td>
      <td>${p.retrograde?'<span class="retro">Rx</span>':''}</td>
      <td style="text-align:right"><span class="deg-pill">${s.deg}Â°${ms}'</span></td>`;
    tbody.appendChild(tr);
  });
}

// â”€â”€ ASPECT LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAspectLegend(data){
  const aspects=calcAspects(data);
  const seen=new Set();
  const el=document.getElementById('aspectLegend');
  if(!el) return;
  el.innerHTML='';
  aspects.forEach(({asp})=>{
    const n=aspName(asp);
    if(seen.has(n)) return; seen.add(n);
    const item=document.createElement('div'); item.className='asp-item';
    const line=document.createElement('div'); line.className='asp-line';
    line.style.background=asp.color.replace(/[\d.]+\)/,'1)');
    if(asp.dash) line.style.backgroundImage=`repeating-linear-gradient(90deg,${line.style.background} 0,${line.style.background} 4px,transparent 4px,transparent 7px)`;
    item.appendChild(line);
    item.appendChild(document.createTextNode(n));
    el.appendChild(item);
  });
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentDate=new Date(),isLive=true,isAnimating=false;
let animSpeed=7,animFrame=null,lastAnimTs=null;

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(d){
  const iso=d.toISOString();
  const locale=currentLang==='pl'?'pl-PL':'en-GB';
  document.getElementById('current-date').textContent=
    d.toLocaleDateString(locale,{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',timeZone:'UTC'})+' UTC';
  document.getElementById('modeBadge').style.display=isLive?'none':'inline-block';
  document.getElementById('liveDot').classList.toggle('paused',!isLive);
  document.getElementById('liveLabel').textContent=isLive?t('live'):t('historical');
  document.getElementById('datePicker').value=iso.slice(0,10);
  document.getElementById('timePicker').value=iso.slice(11,16);
  const data=calcData(d);
  renderList(data);
  drawWheel(data);
  const phase=moonPhase(data);
  if(phase){
    document.getElementById('moonEmoji').textContent=phase.emoji;
    document.getElementById('moonName').textContent=phase.name;
    document.getElementById('moonPct').textContent=phase.illum+'%';
    document.getElementById('moonFill').style.width=phase.illum+'%';
  }
  renderAspectLegend(data);
}

// â”€â”€ TIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function stepDate(d,amount,unit){
  const MS={minute:60000,hour:3600000,day:86400000,week:604800000};
  if(unit==='month'){const nd=new Date(d);nd.setUTCMonth(nd.getUTCMonth()+amount);return nd;}
  if(unit==='year'){const nd=new Date(d);nd.setUTCFullYear(nd.getUTCFullYear()+amount);return nd;}
  return new Date(d.getTime()+amount*(MS[unit]||MS.day));
}
function goToDate(d){currentDate=d;isLive=false;render(currentDate);}
function goLive(){currentDate=new Date();isLive=true;stopAnimation();render(currentDate);}
function startAnimation(){
  if(isAnimating)return;
  isAnimating=true;isLive=false;lastAnimTs=null;
  document.getElementById('animBtn').textContent=t('pause');
  document.getElementById('animBtn').classList.add('active');
  (function tick(ts){
    if(!lastAnimTs)lastAnimTs=ts;
    currentDate=new Date(currentDate.getTime()+animSpeed*86400000*(ts-lastAnimTs)/1000);
    lastAnimTs=ts;render(currentDate);
    animFrame=requestAnimationFrame(tick);
  })(performance.now());
}
function stopAnimation(){
  isAnimating=false;
  if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  document.getElementById('animBtn').textContent=t('play');
  document.getElementById('animBtn').classList.remove('active');
}

// â”€â”€ EVENTS (Sky) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('[data-step]').forEach(b=>b.addEventListener('click',()=>{
  stopAnimation();goToDate(stepDate(currentDate,parseInt(b.dataset.step),b.dataset.unit));
}));
document.getElementById('jumpBtn').addEventListener('click',()=>{
  stopAnimation();
  const dp=document.getElementById('datePicker').value;
  const tp=document.getElementById('timePicker').value||'12:00';
  if(dp) goToDate(new Date(dp+'T'+tp+':00Z'));
});
document.getElementById('nowBtn').addEventListener('click',()=>goLive());
document.getElementById('animBtn').addEventListener('click',()=>isAnimating?stopAnimation():startAnimation());
document.querySelectorAll('[data-animspeed]').forEach(b=>b.addEventListener('click',()=>{
  animSpeed=parseFloat(b.dataset.animspeed);
  document.querySelectorAll('[data-animspeed]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  if(isAnimating){stopAnimation();startAnimation();}
}));
setInterval(()=>{if(isLive&&!isAnimating){currentDate=new Date();render(currentDate);}},60000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let profiles=JSON.parse(localStorage.getItem('wrozai_profiles')||localStorage.getItem('celestia_profiles')||'[]');
let editingProfileId=null;
let selectedProfileId=null;

function saveProfiles(){localStorage.setItem('wrozai_profiles',JSON.stringify(profiles));}

window.openAddProfile=function(){
  editingProfileId=null;
  document.getElementById('profileModalTitle').innerHTML='âœ¦ '+t('addProfile');
  document.getElementById('pName').value='';
  document.getElementById('pDate').value='';
  document.getElementById('pTime').value='12:00';
  document.getElementById('pPlace').value='';
  document.getElementById('profileModal').classList.add('open');
};
window.closeModal=function(id){document.getElementById(id).classList.remove('open');};

document.getElementById('saveProfileBtn').addEventListener('click',async()=>{
  const name=document.getElementById('pName').value.trim();
  const date=document.getElementById('pDate').value;
  const time=document.getElementById('pTime').value||'12:00';
  const place=document.getElementById('pPlace').value.trim();
  if(!name||!date){alert(currentLang==='pl'?'Podaj imiÄ™ i datÄ™ urodzin.':'Please enter at least a name and birth date.');return;}
  const birthDate=new Date(date+'T'+time+':00Z');

  // Geocode the city
  let geo=null;
  if(place){
    geo=await geocodeCity(place);
  }

  const profileData={
    id:editingProfileId||Date.now().toString(),
    name,date:birthDate.toISOString(),place,
    lat:geo?.lat||null,lon:geo?.lon||null,
    geoName:geo?.name||place||null
  };
  if(editingProfileId){
    const idx=profiles.findIndex(p=>p.id===editingProfileId);
    if(idx>=0) profiles[idx]=profileData;
  } else {
    profiles.push(profileData);
  }
  saveProfiles();
  closeModal('profileModal');
  renderProfiles();
  refreshTransitSelect();
});

function renderProfiles(){
  const el=document.getElementById('profilesList');
  if(!el) return;
  if(profiles.length===0){
    el.innerHTML=`<div class="empty-state"><div class="es-icon">â™¦</div><p>${t('noProfiles').replace('\n','<br>')}</p></div>`;
    document.getElementById('natalSection').style.display='none';
    return;
  }
  el.innerHTML='';
  profiles.forEach(p=>{
    const bd=new Date(p.date);
    const natalData=calcData(bd);
    const sun=natalData[0]?signOf(natalData[0].lon):null;
    const moon=natalData[1]?signOf(natalData[1].lon):null;
    const div=document.createElement('div');
    div.className='profile-card fade-in'+(selectedProfileId===p.id?' selected':'');
    div.innerHTML=`
      <div class="profile-avatar">${p.name[0].toUpperCase()}</div>
      <div class="profile-info">
        <div class="profile-name">${p.name}</div>
        <div class="profile-birth">${bd.toLocaleDateString(currentLang==='pl'?'pl-PL':'en-GB',{year:'numeric',month:'long',day:'numeric'})}${p.place?' Â· '+p.place:''}</div>
        ${sun?`<div class="profile-sun">${PLANET_SYMS[0]} ${sun.name} Â· ${PLANET_SYMS[1]} ${moon?.name||'â€”'}</div>`:''}
        ${p.lat?`<div style="font-size:10px;color:var(--teal);margin-top:2px;">ğŸ“ ${p.lat.toFixed(2)}Â°, ${p.lon.toFixed(2)}Â°</div>`:''}
      </div>
      <div class="profile-actions">
        <button class="btn sm gold" onclick="showNatalChart('${p.id}')">${t('natalChart')}</button>
        <button class="btn sm" onclick="editProfile('${p.id}')">âœ</button>
        <button class="btn sm danger" onclick="deleteProfile('${p.id}')">âœ•</button>
      </div>`;
    el.appendChild(div);
  });
}

window.showNatalChart=async function(id){
  const p=profiles.find(x=>x.id===id);
  if(!p) return;
  selectedProfileId=id;
  renderProfiles();
  const bd=new Date(p.date);
  const natalData=calcData(bd);

  // Compute houses if we have coordinates
  let houses=null;
  if(p.lat&&p.lon&&sweEngine){
    const jd=sweEngine.julday(bd.getUTCFullYear(),bd.getUTCMonth()+1,bd.getUTCDate(),
      bd.getUTCHours()+bd.getUTCMinutes()/60+bd.getUTCSeconds()/3600);
    houses=calcHouses(jd,p.lat,p.lon);
  }

  document.getElementById('natalSection').style.display='block';
  document.getElementById('natalCardTitle').textContent=`${p.name} Â· ${t('natalChart')}`;

  // House info bar
  const info=document.getElementById('natalHouseInfo');
  if(houses){
    const ascSign=signOf(houses.asc);
    const mcSign=signOf(houses.mc);
    info.innerHTML=`
      <span style="color:var(--gold);font-weight:700;">${t('ascendant')} ${ascSign.sym} ${ascSign.name} ${ascSign.deg}Â°${String(ascSign.min).padStart(2,'0')}'</span>
      <span style="color:var(--teal);font-weight:700;">${t('mc')} ${mcSign.sym} ${mcSign.name} ${mcSign.deg}Â°${String(mcSign.min).padStart(2,'0')}'</span>
      <span style="color:var(--muted);">Placidus Â· ${p.geoName?.split(',')[0]||p.place||''}</span>`;
  } else {
    info.innerHTML=`<span style="color:var(--muted);font-style:italic;">${t('geocodeError')}</span>`;
  }

  // Angles summary pills
  const anglesDiv=document.getElementById('natalAngles');
  anglesDiv.innerHTML='';
  if(houses){
    [{lon:houses.asc,label:t('ascendant')},{lon:houses.mc,label:t('mc')}].forEach(({lon,label})=>{
      const s=signOf(lon);
      const pill=document.createElement('div');
      pill.className='deg-pill';
      pill.style.marginRight='6px';
      pill.innerHTML=`${label}: <span style="color:${s.color}">${s.sym}</span> ${s.name} ${s.deg}Â°${String(s.min).padStart(2,'0')}'`;
      anglesDiv.appendChild(pill);
    });
  }

  drawNatalWheel(natalData, houses, 'natal-wheel');
  renderList(natalData,'natal-tbody',houses);
  document.getElementById('natalSection').scrollIntoView({behavior:'smooth'});
};

function redrawNatal(id){
  const p=profiles.find(x=>x.id===id);
  if(!p) return;
  showNatalChart(id);
}

window.editProfile=function(id){
  const p=profiles.find(x=>x.id===id);
  if(!p) return;
  editingProfileId=id;
  document.getElementById('profileModalTitle').innerHTML='âœ¦ '+t('addProfile');
  document.getElementById('pName').value=p.name;
  const bd=new Date(p.date);
  document.getElementById('pDate').value=bd.toISOString().slice(0,10);
  document.getElementById('pTime').value=bd.toISOString().slice(11,16);
  document.getElementById('pPlace').value=p.place||'';
  document.getElementById('profileModal').classList.add('open');
};

window.deleteProfile=function(id){
  if(!confirm(currentLang==='pl'?'UsunÄ…Ä‡ ten profil?':'Delete this profile?')) return;
  profiles=profiles.filter(p=>p.id!==id);
  saveProfiles();
  if(selectedProfileId===id){selectedProfileId=null;document.getElementById('natalSection').style.display='none';}
  renderProfiles();
  refreshTransitSelect();
};

function refreshTransitSelect(){
  const sel=document.getElementById('transitProfileSelect');
  const prev=sel.value;
  sel.innerHTML=`<option value="">${t('selectProfileOpt')}</option>`;
  profiles.forEach(p=>sel.add(new Option(p.name,p.id)));
  if(profiles.find(p=>p.id===prev)) sel.value=prev;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRANSIT CALCULATOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getOrb(aspKey){
  const major=['aspConj','aspOpp','aspTrine','aspSquare'];
  return major.includes(aspKey)?
    parseInt(document.getElementById('orbMajor')?.value||3):
    parseInt(document.getElementById('orbMinor')?.value||1);
}

function calcTransits(natalLons, daysAhead){
  const transits=[];
  const now=new Date();
  const step=24;
  const totalSteps=Math.ceil(daysAhead*24/step);
  for(let s=0;s<=totalSteps;s++){
    const d=new Date(now.getTime()+s*step*3600000);
    const skyData=calcData(d);
    for(const tIdx of TRANSIT_PLANET_IDXS){
      const tLon=skyData[tIdx]?.lon;
      if(tLon==null) continue;
      for(let nIdx=0;nIdx<10;nIdx++){
        const nLon=natalLons[nIdx];
        if(nLon==null) continue;
        for(const aspDef of ASPECT_DEFS){
          const orb=getOrb(aspDef.key);
          let diff=Math.abs(tLon-nLon);
          if(diff>180) diff=360-diff;
          const sep=Math.abs(diff-aspDef.angle);
          if(sep<=orb){
            const key=`${tIdx}-${nIdx}-${aspDef.key}`;
            const existing=transits.find(t=>t.key===key&&Math.abs(t.date-d)<7*86400000);
            if(!existing){
              transits.push({key,date:d,tIdx,nIdx,
                tName:pName(tIdx),tSym:PLANET_SYMS[tIdx],tColor:PLANET_COLORS[tIdx],
                nName:pName(nIdx),nSym:PLANET_SYMS[nIdx],nColor:PLANET_COLORS[nIdx],
                aspName:aspName(aspDef),aspSym:aspDef.sym,aspCls:aspDef.cls,aspKey:aspDef.key,
                orb:sep.toFixed(1)
              });
            }
          }
        }
      }
    }
  }
  const seen=new Set();
  return transits
    .sort((a,b)=>a.date-b.date)
    .filter(t=>{if(seen.has(t.key))return false;seen.add(t.key);return true;});
}

document.getElementById('calcTransitsBtn').addEventListener('click',()=>{
  const pid=document.getElementById('transitProfileSelect').value;
  if(!pid){alert(currentLang==='pl'?'Najpierw wybierz profil.':'Please select a birth profile first.');return;}
  const p=profiles.find(x=>x.id===pid);
  if(!p) return;
  const days=parseInt(document.getElementById('transitDays').value);
  const bd=new Date(p.date);
  const natalData=calcData(bd);
  const natalLons=natalData.map(d=>d?.lon??null);
  const btn=document.getElementById('calcTransitsBtn');
  btn.textContent=currentLang==='pl'?'Obliczamâ€¦':'Calculatingâ€¦';
  btn.disabled=true;
  setTimeout(()=>{
    const transits=calcTransits(natalLons,days);
    renderTransits(transits,p.name);
    btn.textContent=t('calcTransits');
    btn.disabled=false;
  },50);
});

function renderTransits(transits,profileName){
  const el=document.getElementById('transitResults');
  if(!el) return;
  if(transits.length===0){
    el.innerHTML=`<div class="empty-state"><div class="es-icon">âœ¦</div><p>${t('transitEmpty')}</p></div>`;
    return;
  }
  const now=new Date();
  const locale=currentLang==='pl'?'pl-PL':'en-GB';
  el.innerHTML=`<div style="font-size:11px;color:var(--muted);padding:4px 0 10px;">${transits.length} ${t('natalFor')} <strong style="color:var(--accent)">${profileName}</strong></div>`;
  const card=document.createElement('div');
  card.className='card';card.style.overflow='hidden';
  transits.forEach(t=>{
    const daysAway=Math.round((t.date-now)/86400000);
    const dateStr=t.date.toLocaleDateString(locale,{weekday:'short',day:'numeric',month:'short',year:'numeric'});
    const item=document.createElement('div');
    item.className='transit-item fade-in';
    let dayLabel;
    if(daysAway===0) dayLabel=currentLang==='pl'?'DziÅ›':'Today';
    else if(daysAway<0) dayLabel=`${Math.abs(daysAway)}${currentLang==='pl'?' d temu':' d ago'}`;
    else dayLabel=`${daysAway}${currentLang==='pl'?' d':' d'}`;
    item.innerHTML=`
      <div class="transit-icon ${t.aspCls}">${t.aspSym}</div>
      <div class="transit-meta">
        <div class="transit-planets">
          <span style="color:${t.tColor}">${t.tSym} ${t.tName}</span>
          <span style="color:var(--muted);margin:0 4px;">${t.aspSym}</span>
          <span style="color:${t.nColor}">natal ${t.nSym} ${t.nName}</span>
        </div>
        <div class="transit-aspect">${t.aspName}</div>
        <div class="transit-date">ğŸ“… ${dateStr}</div>
      </div>
      <div class="transit-orb">${dayLabel}</div>`;
    card.appendChild(item);
  });
  el.appendChild(card);
}

</script>
</body>
</html>
