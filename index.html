<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Celestia">
<meta name="theme-color" content="#0d1120">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Raleway:wght@300;400;600;700&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<title>Celestia ¬∑ Astrological Clock</title>
<style>
:root {
  --bg:#0d1120; --surface:#111828; --surface2:#161f35; --surface3:#1a2540;
  --accent:#7ba4d4; --accent2:#5585ba; --gold:#c8a040; --gold2:#e8c060;
  --teal:#2aa8b8; --muted:#6880a8; --border:#1e2d4a; --border2:#2a3d60;
  --red:#e05555; --green:#4ade80; --shadow:0 4px 28px rgba(0,0,0,.6);
  --r:12px;
}
body.light {
  --bg:#f0f4fb; --surface:#fff; --surface2:#f8faff; --surface3:#eef4ff;
  --accent:#1e3a5f; --accent2:#2d5a8e; --gold:#9a6f20; --gold2:#c49030;
  --teal:#1a7a8a; --muted:#6070a0; --border:#dce4f4; --border2:#b0c4dc;
  --red:#b03030; --shadow:0 4px 28px rgba(30,58,95,.14);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{
  background:var(--bg);
  font-family:'Raleway',sans-serif;
  color:#c8d8f0;
  min-height:100vh;
  padding-bottom:env(safe-area-inset-bottom);
}
body.light{color:#1e3a5f;}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  background:var(--surface);
  border-top:1px solid var(--border);
  display:flex;
  padding-bottom:env(safe-area-inset-bottom);
  z-index:100;
}
.nav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;
  padding:10px 4px 8px;gap:3px;cursor:pointer;
  color:var(--muted);font-size:8px;font-weight:700;letter-spacing:1px;
  text-transform:uppercase;border:none;background:none;
  transition:color .2s;
}
.nav-btn.active{color:var(--gold);}
.nav-icon{font-size:20px;line-height:1;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;min-height:calc(100vh - 60px);padding:16px 12px 80px;}
.screen.active{display:block;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.app-header{
  text-align:center;padding:20px 16px 14px;
  background:linear-gradient(180deg,var(--surface) 0%,transparent 100%);
}
.app-title{
  font-family:'Cinzel',serif;font-size:22px;font-weight:700;
  color:var(--gold);letter-spacing:4px;text-transform:uppercase;
  text-shadow:0 0 30px rgba(200,160,64,.4);
}
.app-subtitle{font-family:'Lora',serif;font-style:italic;color:var(--muted);font-size:12px;margin-top:3px;}
.accent-bar{width:40px;height:2px;background:linear-gradient(90deg,var(--accent),var(--gold));border-radius:1px;margin:8px auto 0;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{
  background:var(--surface);border:1px solid var(--border);
  border-radius:var(--r);margin-bottom:12px;overflow:hidden;
  box-shadow:var(--shadow);
}
.card-header{
  background:linear-gradient(135deg,rgba(30,58,95,.8) 0%,rgba(45,90,142,.6) 100%);
  border-bottom:1px solid var(--border);
  padding:10px 16px;display:flex;align-items:center;gap:8px;
}
.card-title{font-size:9px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:rgba(200,220,255,.85);}
.card-body{padding:14px 16px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{
  border:1px solid var(--border2);background:var(--surface2);
  color:var(--accent);font-family:'Raleway',sans-serif;
  font-size:11px;font-weight:700;letter-spacing:.5px;
  padding:7px 14px;border-radius:6px;cursor:pointer;
  transition:all .15s;white-space:nowrap;
}
.btn:hover{background:var(--surface3);border-color:var(--accent);}
.btn:active{transform:scale(.97);}
.btn.primary{background:var(--accent2);color:#fff;border-color:var(--accent2);}
.btn.primary:hover{background:var(--accent);}
.btn.gold{background:linear-gradient(135deg,#3a2800,#2a1d00);color:var(--gold);border-color:#5a4010;}
.btn.gold:hover{background:linear-gradient(135deg,#4a3800,#3a2d00);}
.btn.danger{background:rgba(180,30,30,.15);color:var(--red);border-color:rgba(180,30,30,.3);}
.btn.sm{padding:5px 10px;font-size:10px;}
.btn.active{background:var(--teal);color:#fff;border-color:var(--teal);}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.field{margin-bottom:12px;}
.field label{display:block;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.input{
  width:100%;background:var(--surface3);border:1px solid var(--border2);
  color:inherit;font-family:'Raleway',sans-serif;font-size:13px;
  padding:9px 12px;border-radius:6px;outline:none;
  transition:border .15s;
}
.input:focus{border-color:var(--accent);}
body.light .input{color:#1e3a5f;}
.input-row{display:flex;gap:8px;}
.input-row .field{flex:1;}

/* ‚îÄ‚îÄ LIVE BADGE ‚îÄ‚îÄ */
.live-badge{display:flex;align-items:center;gap:5px;font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s infinite;}
.live-dot.paused{background:var(--red);animation:none;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* ‚îÄ‚îÄ WHEEL ‚îÄ‚îÄ */
.wheel-wrap{background:radial-gradient(ellipse at center,#131c32 0%,#0a1020 100%);display:flex;justify-content:center;padding:16px;}
body.light .wheel-wrap{background:radial-gradient(ellipse at center,#eef2fb 0%,#e0e8f8 100%);}
#horoscope-wheel{width:100%;max-width:540px;height:auto;filter:drop-shadow(0 3px 16px rgba(100,150,220,.2));}

/* ‚îÄ‚îÄ TIME CONTROLS ‚îÄ‚îÄ */
.current-time{text-align:center;font-size:12px;font-weight:600;color:var(--accent);padding:8px 0;}
.step-row{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin:6px 0;}
.picker-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center;padding:6px 0;}
.date-input{
  background:var(--surface3);border:1px solid var(--border2);color:inherit;
  font-family:'Raleway',sans-serif;font-size:12px;padding:6px 8px;border-radius:6px;
  outline:none;
}
body.light .date-input{color:#1e3a5f;}
.anim-row{display:flex;gap:4px;justify-content:center;flex-wrap:wrap;padding:6px 0 0;}

/* ‚îÄ‚îÄ MOON BAR ‚îÄ‚îÄ */
.moon-bar{display:flex;align-items:center;gap:12px;padding:12px 16px;border-top:1px solid var(--border);}
.moon-emoji{font-size:28px;flex-shrink:0;}
.moon-info{flex:1;}
.moon-name{font-size:11px;font-weight:700;color:var(--accent);letter-spacing:.5px;margin-bottom:4px;}
.moon-track{height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.moon-fill{height:100%;background:linear-gradient(90deg,var(--gold),#ff9900);border-radius:3px;transition:width .5s ease;}
.moon-pct{font-size:14px;font-weight:700;color:var(--gold2);}

/* ‚îÄ‚îÄ PLANET TABLE ‚îÄ‚îÄ */
.planet-table{width:100%;border-collapse:collapse;}
.planet-table thead th{
  padding:8px 10px;font-size:9px;font-weight:700;letter-spacing:1.5px;
  text-transform:uppercase;color:var(--muted);text-align:left;
  border-bottom:1px solid var(--border);
}
.planet-table tbody tr{border-bottom:1px solid var(--border);transition:background .12s;}
.planet-table tbody tr:hover{background:var(--surface2);}
.planet-table td{padding:9px 10px;vertical-align:middle;}
.td-sym{font-size:19px;width:28px;}
.td-name{font-size:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;color:var(--accent);width:80px;}
.td-sign{display:flex;align-items:center;gap:5px;}
.sign-sym{font-size:15px;}
.sign-nm{font-family:'Lora',serif;font-style:italic;font-size:13px;color:var(--teal);}
.retro{color:var(--red);font-size:9px;font-weight:700;background:rgba(180,30,30,.15);padding:2px 5px;border-radius:3px;}
.deg-pill{
  display:inline-block;font-size:11px;font-weight:700;
  background:linear-gradient(135deg,rgba(200,160,64,.2),rgba(200,160,64,.1));
  color:var(--gold);padding:3px 9px;border-radius:10px;
}

/* ‚îÄ‚îÄ ASPECT LEGEND ‚îÄ‚îÄ */
.aspect-legend{display:flex;gap:6px;flex-wrap:wrap;padding:10px 16px;border-top:1px solid var(--border);}
.asp-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);}
.asp-line{width:18px;height:2px;border-radius:1px;flex-shrink:0;}

/* ‚îÄ‚îÄ PROFILES ‚îÄ‚îÄ */
.profile-card{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;padding:14px;margin-bottom:10px;
  display:flex;align-items:center;gap:12px;cursor:pointer;
  transition:all .2s;
}
.profile-card:hover{border-color:var(--accent);}
.profile-card.selected{border-color:var(--gold);background:rgba(200,160,64,.08);}
.profile-avatar{
  width:44px;height:44px;border-radius:50%;
  background:linear-gradient(135deg,var(--accent2),var(--teal));
  display:flex;align-items:center;justify-content:center;
  font-size:20px;flex-shrink:0;
}
.profile-info{flex:1;}
.profile-name{font-size:14px;font-weight:700;color:var(--accent);}
.profile-birth{font-size:11px;color:var(--muted);margin-top:2px;}
.profile-sun{font-size:11px;color:var(--gold);margin-top:2px;}
.profile-actions{display:flex;gap:6px;}

/* ‚îÄ‚îÄ TRANSITS ‚îÄ‚îÄ */
.transit-item{
  padding:12px 16px;border-bottom:1px solid var(--border);
  display:flex;gap:10px;align-items:flex-start;
}
.transit-item:last-child{border-bottom:none;}
.transit-icon{
  width:36px;height:36px;border-radius:8px;flex-shrink:0;
  display:flex;align-items:center;justify-content:center;
  font-size:16px;
}
.transit-icon.conj{background:rgba(100,100,200,.2);color:#aaaaff;}
.transit-icon.trine{background:rgba(40,160,80,.2);color:#80e0a0;}
.transit-icon.square{background:rgba(200,50,50,.2);color:#ff9090;}
.transit-icon.opp{background:rgba(180,40,40,.2);color:#ff8080;}
.transit-icon.sext{background:rgba(40,120,200,.2);color:#80b8ff;}
.transit-meta{flex:1;}
.transit-planets{font-size:12px;font-weight:700;color:var(--accent);}
.transit-aspect{font-size:11px;color:var(--muted);margin-top:2px;}
.transit-date{font-size:11px;color:var(--gold);margin-top:3px;font-weight:600;}
.transit-orb{
  font-size:10px;font-weight:700;
  background:var(--surface3);border:1px solid var(--border2);
  color:var(--muted);padding:2px 7px;border-radius:8px;
  white-space:nowrap;align-self:center;
}

/* ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ */
.notif-toggle{display:flex;align-items:center;justify-content:space-between;padding:12px 0;}
.toggle-switch{
  width:44px;height:24px;border-radius:12px;background:var(--border);
  position:relative;cursor:pointer;transition:background .2s;flex-shrink:0;
}
.toggle-switch.on{background:var(--teal);}
.toggle-knob{
  width:20px;height:20px;border-radius:50%;background:#fff;
  position:absolute;top:2px;left:2px;transition:left .2s;
  box-shadow:0 1px 4px rgba(0,0,0,.4);
}
.toggle-switch.on .toggle-knob{left:22px;}
.notif-label{font-size:12px;font-weight:600;color:var(--accent);}
.notif-desc{font-size:10px;color:var(--muted);margin-top:2px;}

/* ‚îÄ‚îÄ TOOLTIP ‚îÄ‚îÄ */
#planetTooltip{
  position:fixed;z-index:9999;display:flex;align-items:center;gap:8px;
  background:rgba(10,18,40,0.96);border:1px solid rgba(100,140,220,.3);
  border-radius:8px;padding:7px 13px;pointer-events:none;white-space:nowrap;
  box-shadow:0 4px 20px rgba(0,0,0,.5);
}
.tip-sym{font-size:18px;}
.tip-name{font-size:11px;font-weight:700;color:#b8d0ff;letter-spacing:1px;text-transform:uppercase;}
.tip-deg{font-size:13px;font-weight:800;color:var(--gold);}

/* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
#loadingMsg{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(10,15,30,0.92);z-index:999;
  align-items:center;justify-content:center;flex-direction:column;gap:14px;
  color:#c0d0f0;font-size:14px;letter-spacing:2px;
}
.spinner{width:40px;height:40px;border:3px solid rgba(120,160,220,.2);border-top-color:var(--accent);border-radius:50%;animation:spin .9s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{
  display:none;position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(5,10,25,.85);z-index:200;
  align-items:flex-end;justify-content:center;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--surface);border:1px solid var(--border);
  border-radius:16px 16px 0 0;padding:20px 20px calc(20px + env(safe-area-inset-bottom));
  width:100%;max-width:500px;max-height:85vh;overflow-y:auto;
}
.modal-title{font-family:'Cinzel',serif;font-size:16px;font-weight:600;color:var(--gold);margin-bottom:16px;letter-spacing:2px;}
.modal-actions{display:flex;gap:8px;margin-top:16px;}

/* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
.sect-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);letter-spacing:2px;margin-bottom:12px;}
.empty-state{text-align:center;padding:40px 20px;color:var(--muted);}
.empty-state .es-icon{font-size:48px;margin-bottom:12px;opacity:.5;}
.empty-state p{font-size:13px;line-height:1.6;}
.tag{
  display:inline-block;font-size:9px;font-weight:700;letter-spacing:.8px;
  text-transform:uppercase;padding:2px 7px;border-radius:8px;
  background:rgba(200,160,64,.15);color:var(--gold);border:1px solid rgba(200,160,64,.2);
}
.row{display:flex;gap:8px;align-items:center;}
.row.between{justify-content:space-between;}
.divider{height:1px;background:var(--border);margin:12px 0;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.fade-in{animation:fadeIn .3s ease both;}

/* Header toolbar */
.header-toolbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px 4px;}
.ht-title{font-family:'Cinzel',serif;font-size:10px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;}

/* Install banner */
.install-banner{
  background:linear-gradient(135deg,rgba(30,58,95,.6),rgba(42,168,184,.2));
  border:1px solid rgba(42,168,184,.3);border-radius:8px;
  padding:12px 14px;margin-bottom:12px;display:flex;align-items:center;gap:12px;
}
.install-banner .ib-text{flex:1;font-size:11px;color:var(--teal);}
.install-banner .ib-title{font-weight:700;font-size:13px;color:var(--accent);margin-bottom:3px;}
</style>
</head>
<body>

<div id="loadingMsg"><div class="spinner"></div>Loading Swiss Ephemeris‚Ä¶</div>
<div id="planetTooltip" style="display:none;">
  <span class="tip-sym"></span>
  <span class="tip-name"></span>
  <span class="tip-deg"></span>
</div>

<!-- ADD PROFILE MODAL -->
<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <div class="modal-title" id="profileModalTitle">‚ú¶ Add Birth Profile</div>
    <div class="field"><label>Name</label><input class="input" id="pName" placeholder="e.g. Anna"></div>
    <div class="input-row">
      <div class="field"><label>Birth Date</label><input class="input date-input" type="date" id="pDate"></div>
      <div class="field"><label>Birth Time</label><input class="input date-input" type="time" id="pTime" value="12:00"></div>
    </div>
    <div class="field"><label>Birth Place (optional)</label><input class="input" id="pPlace" placeholder="e.g. Warsaw, Poland"></div>
    <div class="modal-actions">
      <button class="btn primary" id="saveProfileBtn" style="flex:1">Save Profile</button>
      <button class="btn" onclick="closeModal('profileModal')">Cancel</button>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-screen="sky" onclick="switchScreen('sky')">
    <span class="nav-icon">‚óØ</span>Sky Now
  </button>
  <button class="nav-btn" data-screen="profiles" onclick="switchScreen('profiles')">
    <span class="nav-icon">‚ô¶</span>Profiles
  </button>
  <button class="nav-btn" data-screen="transits" onclick="switchScreen('transits')">
    <span class="nav-icon">‚ü≥</span>Transits
  </button>
  <button class="nav-btn" data-screen="settings" onclick="switchScreen('settings')">
    <span class="nav-icon">‚öô</span>Settings
  </button>
</nav>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 1: SKY NOW                                           -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen-sky">
  <div style="text-align:center;padding:16px 12px 10px;">
    <div class="app-title">Celestia</div>
    <div class="app-subtitle">Astrological Clock ¬∑ Swiss Ephemeris</div>
    <div class="accent-bar"></div>
  </div>

  <div id="installBanner" style="display:none;" class="install-banner fade-in">
    <span style="font-size:28px">üì≤</span>
    <div class="ib-text">
      <div class="ib-title">Install as App</div>
      On Android: tap ‚ãÆ menu ‚Üí "Add to Home screen"<br>
      On iPhone: tap Share ‚Üí "Add to Home Screen"
    </div>
    <button class="btn sm" onclick="document.getElementById('installBanner').style.display='none'">‚úï</button>
  </div>

  <!-- Zodiac Wheel -->
  <div class="card">
    <div class="card-header">
      <span style="font-size:14px;color:rgba(255,255,255,.7)">‚óØ</span>
      <span class="card-title">Zodiac Wheel ¬∑ Current Sky</span>
      <div style="margin-left:auto;" class="live-badge">
        <span class="live-dot" id="liveDot"></span>
        <span id="liveLabel">LIVE</span>
      </div>
    </div>
    <div class="wheel-wrap">
      <svg id="horoscope-wheel" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg"></svg>
    </div>
    <div class="moon-bar">
      <span class="moon-emoji" id="moonEmoji">üåë</span>
      <div class="moon-info">
        <div class="moon-name" id="moonName">‚Äî</div>
        <div class="moon-track"><div class="moon-fill" id="moonFill" style="width:0%"></div></div>
      </div>
      <span class="moon-pct" id="moonPct">‚Äî</span>
    </div>
    <div class="aspect-legend" id="aspectLegend"></div>
  </div>

  <!-- Time Navigation -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">‚è± Time Navigation</span>
      <span class="mode-badge" id="modeBadge" style="margin-left:auto;font-size:9px;background:rgba(200,160,64,.15);color:var(--gold);border:1px solid rgba(200,160,64,.3);padding:2px 8px;border-radius:8px;display:none;">HISTORICAL MODE</span>
    </div>
    <div class="card-body">
      <div class="current-time" id="current-date">‚Äî</div>
      <div class="step-row">
        <button class="btn sm" data-step="-1" data-unit="week">‚óÄ Week</button>
        <button class="btn sm" data-step="-1" data-unit="day">‚óÄ Day</button>
        <button class="btn sm" data-step="-1" data-unit="hour">‚óÄ Hr</button>
        <button class="btn sm" data-step="1" data-unit="hour">Hr ‚ñ∂</button>
        <button class="btn sm" data-step="1" data-unit="day">Day ‚ñ∂</button>
        <button class="btn sm" data-step="1" data-unit="week">Week ‚ñ∂</button>
      </div>
      <div class="picker-row">
        <input type="date" class="date-input" id="datePicker">
        <input type="time" class="date-input" id="timePicker" value="12:00" style="width:86px;">
        <button class="btn primary sm" id="jumpBtn">Jump ‚Üµ</button>
        <button class="btn danger sm" id="nowBtn">‚ü≥ Now</button>
      </div>
      <div class="anim-row">
        <span style="font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;">Animation:</span>
        <button class="btn sm" id="animBtn">‚ñ∂ Play</button>
        <button class="btn sm" data-animspeed="1">1d/s</button>
        <button class="btn sm active" data-animspeed="7">1w/s</button>
        <button class="btn sm" data-animspeed="30">1m/s</button>
        <button class="btn sm" data-animspeed="-7">‚óÄ Back</button>
      </div>
    </div>
  </div>

  <!-- Planet Table -->
  <div class="card">
    <div class="card-header">
      <span style="font-size:14px;color:rgba(255,255,255,.7)">‚ôÉ</span>
      <span class="card-title">Planet Positions</span>
    </div>
    <table class="planet-table">
      <thead><tr>
        <th></th><th>Planet</th><th>Sign</th><th></th><th style="text-align:right">Degrees</th>
      </tr></thead>
      <tbody id="planet-tbody"></tbody>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 2: BIRTH PROFILES                                    -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-profiles">
  <div style="padding:16px 0 8px;display:flex;align-items:center;justify-content:space-between;">
    <div>
      <div class="app-title" style="font-size:16px;letter-spacing:3px;">Profiles</div>
      <div class="app-subtitle">Birth charts & natal data</div>
    </div>
    <button class="btn gold" onclick="openAddProfile()">+ Add Profile</button>
  </div>

  <div id="profilesList">
    <div class="empty-state">
      <div class="es-icon">‚ô¶</div>
      <p>No birth profiles yet.<br>Add your first profile to track personal transits.</p>
    </div>
  </div>

  <!-- Natal Chart Display -->
  <div id="natalSection" style="display:none;">
    <div class="card" id="natalCard">
      <div class="card-header">
        <span style="font-size:14px;color:rgba(255,255,255,.7)">‚òΩ</span>
        <span class="card-title" id="natalCardTitle">Natal Chart</span>
      </div>
      <div class="wheel-wrap">
        <svg id="natal-wheel" viewBox="0 0 520 520" xmlns="http://www.w3.org/2000/svg"></svg>
      </div>
      <div class="card-body">
        <table class="planet-table">
          <thead><tr>
            <th></th><th>Planet</th><th>Sign</th><th></th><th style="text-align:right">Degrees</th>
          </tr></thead>
          <tbody id="natal-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 3: TRANSITS                                          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-transits">
  <div style="padding:16px 0 12px;">
    <div class="app-title" style="font-size:16px;letter-spacing:3px;">Transits</div>
    <div class="app-subtitle">Upcoming planetary aspects to natal positions</div>
  </div>

  <div class="card" style="margin-bottom:12px;">
    <div class="card-body" style="padding:10px 14px;">
      <div class="row between">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--accent);">Profile</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Select whose transits to show</div>
        </div>
        <select class="date-input" id="transitProfileSelect" style="max-width:160px;">
          <option value="">‚Äî Select Profile ‚Äî</option>
        </select>
      </div>
      <div class="divider"></div>
      <div class="row between">
        <div>
          <div style="font-size:11px;font-weight:700;color:var(--accent);">Look ahead</div>
          <div style="font-size:10px;color:var(--muted);margin-top:2px;">Search window</div>
        </div>
        <select class="date-input" id="transitDays" style="max-width:120px;">
          <option value="30">30 days</option>
          <option value="60">60 days</option>
          <option value="90" selected>90 days</option>
          <option value="180">180 days</option>
          <option value="365">1 year</option>
        </select>
      </div>
      <div class="divider"></div>
      <button class="btn primary" style="width:100%;" id="calcTransitsBtn">Calculate Transits</button>
    </div>
  </div>

  <div id="transitResults">
    <div class="empty-state">
      <div class="es-icon">‚ü≥</div>
      <p>Select a birth profile and calculate to see upcoming transits.</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!--  SCREEN 4: SETTINGS                                          -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen-settings">
  <div style="padding:16px 0 12px;">
    <div class="app-title" style="font-size:16px;letter-spacing:3px;">Settings</div>
    <div class="app-subtitle">Preferences & notifications</div>
  </div>

  <!-- Push Notifications -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">üîî Push Notifications</span>
    </div>
    <div class="card-body">
      <div class="notif-toggle">
        <div>
          <div class="notif-label">Transit Alerts</div>
          <div class="notif-desc">Notify me of major upcoming transits</div>
        </div>
        <div class="toggle-switch" id="notifToggle" onclick="toggleNotifications()">
          <div class="toggle-knob"></div>
        </div>
      </div>
      <div id="notifStatus" style="font-size:11px;color:var(--muted);margin-top:4px;"></div>
      <div class="divider"></div>
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:8px;">Alert timing</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;" id="alertTiming">
        <button class="btn sm active" data-days="1">1 day before</button>
        <button class="btn sm" data-days="3">3 days before</button>
        <button class="btn sm" data-days="7">1 week before</button>
      </div>
      <div class="divider"></div>
      <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:8px;">Notify for aspects</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;" id="alertAspects">
        <button class="btn sm active" data-asp="Conjunction">Conjunction</button>
        <button class="btn sm active" data-asp="Opposition">Opposition</button>
        <button class="btn sm active" data-asp="Trine">Trine</button>
        <button class="btn sm active" data-asp="Square">Square</button>
        <button class="btn sm" data-asp="Sextile">Sextile</button>
      </div>
      <div class="divider"></div>
      <button class="btn primary" style="width:100%;" id="scheduleNotifBtn" onclick="scheduleTransitNotifications()">Schedule Notifications</button>
    </div>
  </div>

  <!-- Appearance -->
  <div class="card">
    <div class="card-header"><span class="card-title">üé® Appearance</span></div>
    <div class="card-body">
      <div class="notif-toggle">
        <div>
          <div class="notif-label">Light Mode</div>
          <div class="notif-desc">Switch between dark and light theme</div>
        </div>
        <div class="toggle-switch" id="themeToggle" onclick="toggleTheme()">
          <div class="toggle-knob"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Orb settings -->
  <div class="card">
    <div class="card-header"><span class="card-title">‚öô Transit Orbs</span></div>
    <div class="card-body">
      <div style="font-size:11px;color:var(--muted);margin-bottom:10px;">
        Orb (degrees of tolerance) used when detecting transits
      </div>
      <div class="input-row">
        <div class="field"><label>Major aspects (¬∞)</label><input class="input" type="number" id="orbMajor" value="3" min="1" max="10" style="width:100%;"></div>
        <div class="field"><label>Minor aspects (¬∞)</label><input class="input" type="number" id="orbMinor" value="1" min="1" max="5" style="width:100%;"></div>
      </div>
    </div>
  </div>

  <!-- About -->
  <div class="card">
    <div class="card-header"><span class="card-title">‚Ñπ About</span></div>
    <div class="card-body">
      <div style="font-size:12px;color:var(--muted);line-height:1.7;">
        <strong style="color:var(--accent)">Celestia PWA</strong> uses the Swiss Ephemeris engine (Astrodienst AG) for sub-arcminute planetary calculations. All data is calculated locally on your device ‚Äî no data is sent to any server.
        <br><br>
        Tropical zodiac (Aries = 0¬∞ at vernal equinox).
      </div>
    </div>
  </div>
</div>

<script type="module">
import SwissEph from 'https://cdn.jsdelivr.net/gh/prolaxu/swisseph-wasm@main/src/swisseph.js';

const DEG=Math.PI/180, RAD=180/Math.PI;
const norm=d=>((d%360)+360)%360;

// ‚îÄ‚îÄ ZODIAC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SIGNS=[
  {name:'Aries',     sym:'‚ôà',color:'#c0392b'},
  {name:'Taurus',    sym:'‚ôâ',color:'#27ae60'},
  {name:'Gemini',    sym:'‚ôä',color:'#c8961a'},
  {name:'Cancer',    sym:'‚ôã',color:'#2980b9'},
  {name:'Leo',       sym:'‚ôå',color:'#d35400'},
  {name:'Virgo',     sym:'‚ôç',color:'#16a085'},
  {name:'Libra',     sym:'‚ôé',color:'#8e44ad'},
  {name:'Scorpio',   sym:'‚ôè',color:'#922b21'},
  {name:'Sagittarius',sym:'‚ôê',color:'#ca6f1e'},
  {name:'Capricorn', sym:'‚ôë',color:'#566573'},
  {name:'Aquarius',  sym:'‚ôí',color:'#1a5276'},
  {name:'Pisces',    sym:'‚ôì',color:'#6c3483'},
];
function signOf(lon){
  const i=Math.floor(((lon%360)+360)%360/30);
  const d=((lon%360)+360)%360%30,dg=Math.floor(d),mn=Math.floor((d-dg)*60);
  return{...SIGNS[i],deg:dg,min:mn};
}

// ‚îÄ‚îÄ PLANETS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PLANETS=[
  {name:'Sun',      sym:'‚òâ',color:'#c47c0a',sweId:0},
  {name:'Moon',     sym:'‚òΩ',color:'#2471a3',sweId:1},
  {name:'Mercury',  sym:'‚òø',color:'#707b8a',sweId:2},
  {name:'Venus',    sym:'‚ôÄ',color:'#1e8449',sweId:3},
  {name:'Mars',     sym:'‚ôÇ',color:'#c0392b',sweId:4},
  {name:'Jupiter',  sym:'‚ôÉ',color:'#9a6b00',sweId:5},
  {name:'Saturn',   sym:'‚ôÑ',color:'#7d6608',sweId:6},
  {name:'Uranus',   sym:'‚õ¢',color:'#0e7490',sweId:7},
  {name:'Neptune',  sym:'‚ôÜ',color:'#1a3a7e',sweId:8},
  {name:'Pluto',    sym:'‚ôá',color:'#6d4c41',sweId:9},
  {name:'N. Node',  sym:'‚òä',color:'#9b7200',sweId:11,isNode:true},
  {name:'S. Node',  sym:'‚òã',color:'#9b7200',sweId:11,isNode:true,isSouth:true},
];
const TRANSIT_PLANETS=[0,1,2,3,4,5,6,7,8,9]; // planets that transit (no nodes for transit calc)

// ‚îÄ‚îÄ SWISS EPHEMERIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let sweEngine=null;
async function initSwe(){
  const swe=new SwissEph();
  await swe.initSwissEph();
  sweEngine=swe;
}
function calcData(dateObj){
  if(!sweEngine) return PLANETS.map(()=>null);
  const jd=sweEngine.julday(
    dateObj.getUTCFullYear(),dateObj.getUTCMonth()+1,dateObj.getUTCDate(),
    dateObj.getUTCHours()+dateObj.getUTCMinutes()/60+dateObj.getUTCSeconds()/3600
  );
  const FLAG=(sweEngine.SEFLG_SWIEPH||2)|(sweEngine.SEFLG_SPEED||256);
  return PLANETS.map(p=>{
    try{
      const r=sweEngine.calc_ut(jd,p.sweId,FLAG);
      let lon=norm(r[0]);
      if(p.isSouth) lon=norm(lon+180);
      return{lon,retrograde:p.isSouth?true:r[3]<0};
    }catch(e){return null;}
  });
}

// ‚îÄ‚îÄ MOON PHASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function moonPhase(data){
  const sl=data[0]?.lon,ml=data[1]?.lon;
  if(sl==null||ml==null) return null;
  const a=((ml-sl)%360+360)%360;
  let name,emoji;
  if(a<22.5)       {name='New Moon';            emoji='üåë';}
  else if(a<67.5)  {name='Waxing Crescent';     emoji='üåí';}
  else if(a<112.5) {name='First Quarter';       emoji='üåì';}
  else if(a<157.5) {name='Waxing Gibbous';      emoji='üåî';}
  else if(a<202.5) {name='Full Moon';           emoji='üåï';}
  else if(a<247.5) {name='Waning Gibbous';      emoji='üåñ';}
  else if(a<292.5) {name='Last Quarter';        emoji='üåó';}
  else if(a<337.5) {name='Waning Crescent';     emoji='üåò';}
  else             {name='New Moon';            emoji='üåë';}
  return{name,emoji,illum:Math.round((1-Math.cos(a*DEG))/2*100)};
}

// ‚îÄ‚îÄ ASPECTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const ASPECT_DEFS=[
  {name:'Conjunction',angle:0,  orb:8, color:'rgba(100,100,200,0.55)',dash:'',    width:1.5, cls:'conj'},
  {name:'Opposition', angle:180,orb:8, color:'rgba(180,40,40,0.55)',  dash:'',    width:1.5, cls:'opp'},
  {name:'Trine',      angle:120,orb:7, color:'rgba(40,160,80,0.55)',  dash:'',    width:1.4, cls:'trine'},
  {name:'Square',     angle:90, orb:7, color:'rgba(200,50,50,0.50)',  dash:'5,3', width:1.3, cls:'square'},
  {name:'Sextile',    angle:60, orb:5, color:'rgba(40,120,200,0.50)', dash:'3,2', width:1.2, cls:'sext'},
  {name:'Semisquare', angle:45, orb:2, color:'rgba(180,100,40,0.40)', dash:'2,3', width:0.9, cls:'sext'},
  {name:'Quincunx',   angle:150,orb:2, color:'rgba(160,40,160,0.40)', dash:'4,3', width:0.9, cls:'sext'},
];
function calcAspects(data){
  const aspects=[];
  for(let i=0;i<data.length;i++){
    if(!data[i]||PLANETS[i].isNode) continue;
    for(let j=i+1;j<data.length;j++){
      if(!data[j]||PLANETS[j].isNode) continue;
      let diff=Math.abs(data[i].lon-data[j].lon);
      if(diff>180) diff=360-diff;
      for(const asp of ASPECT_DEFS){
        if(Math.abs(diff-asp.angle)<=asp.orb){aspects.push({p1:i,p2:j,asp});break;}
      }
    }
  }
  return aspects;
}

// ‚îÄ‚îÄ DRAW WHEEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawWheel(data, svgId='horoscope-wheel', natalData=null){
  const svg=document.getElementById(svgId);
  if(!svg) return;
  const cx=260,cy=260,rO=244,rB=208,rI=172;
  svg.innerHTML='';
  const ns='http://www.w3.org/2000/svg';
  const mk=(tag,attrs,txt)=>{const e=document.createElementNS(ns,tag);for(const[k,v]of Object.entries(attrs))e.setAttribute(k,v);if(txt!==undefined)e.textContent=txt;return e;};
  const dark=!document.body.classList.contains('light');

  const defs=mk('defs',{});
  const gr=mk('radialGradient',{id:`bg${svgId}`,cx:'50%',cy:'50%',r:'50%'});
  gr.appendChild(mk('stop',{offset:'0%','stop-color':dark?'#131c32':'#eef2fb'}));
  gr.appendChild(mk('stop',{offset:'100%','stop-color':dark?'#0a1020':'#dde4f5'}));
  defs.appendChild(gr); svg.appendChild(defs);
  svg.appendChild(mk('circle',{cx,cy,r:rO,fill:`url(#bg${svgId})`,stroke:dark?'#1e2d4a':'#b0bcd8','stroke-width':'1.5'}));

  for(let i=0;i<12;i++){
    const a1=(180-i*30)*DEG,a2=(180-(i+1)*30)*DEG;
    const x1=cx+rB*Math.cos(a1),y1=cy+rB*Math.sin(a1);
    const x2=cx+rO*Math.cos(a1),y2=cy+rO*Math.sin(a1);
    const x3=cx+rO*Math.cos(a2),y3=cy+rO*Math.sin(a2);
    const x4=cx+rB*Math.cos(a2),y4=cy+rB*Math.sin(a2);
    svg.appendChild(mk('path',{d:`M ${x1} ${y1} L ${x2} ${y2} A ${rO} ${rO} 0 0 1 ${x3} ${y3} L ${x4} ${y4} A ${rB} ${rB} 0 0 0 ${x1} ${y1}`,fill:SIGNS[i].color+'22',stroke:dark?'#1e2d4a':'#b8c4dc','stroke-width':'0.5'}));
    const ma=(180-(i+0.5)*30)*DEG,rs=(rB+rO)/2;
    svg.appendChild(mk('text',{x:cx+rs*Math.cos(ma),y:cy+rs*Math.sin(ma),'text-anchor':'middle','dominant-baseline':'central',fill:SIGNS[i].color,'font-size':'18','font-weight':'bold','font-family':'serif'},SIGNS[i].sym));
  }
  svg.appendChild(mk('circle',{cx,cy,r:rB,fill:'none',stroke:dark?'#1e2d4a':'#a8b8d8','stroke-width':'1.2'}));
  svg.appendChild(mk('circle',{cx,cy,r:rI,fill:dark?'#0d1626':'#f8faff',stroke:dark?'#182436':'#b8c8e0','stroke-width':'1'}));

  for(let i=0;i<360;i+=5){
    const a=(180-i)*DEG,r1=i%30===0?rI-14:i%10===0?rI-8:rI-4;
    svg.appendChild(mk('line',{x1:cx+rI*Math.cos(a),y1:cy+rI*Math.sin(a),x2:cx+r1*Math.cos(a),y2:cy+r1*Math.sin(a),stroke:i%30===0?(dark?'#4060a0':'#6070a0'):(dark?'#1e2d4a':'#b0bcd8'),'stroke-width':i%30===0?'1.4':'0.6'}));
  }
  for(let i=0;i<12;i++){
    const a=(180-i*30)*DEG;
    svg.appendChild(mk('line',{x1:cx+rI*Math.cos(a),y1:cy+rB*Math.cos(a),x2:cx+rB*Math.cos(a),y2:cy+rB*Math.sin(a),stroke:dark?'#2a3d60':'#8898c0','stroke-width':'0.9'}));
  }

  // Aspect lines
  const aspects=calcAspects(data);
  const rAsp=rI-4;
  aspects.forEach(({p1,p2,asp})=>{
    if(!data[p1]||!data[p2]) return;
    const a1=(180-data[p1].lon)*DEG,a2=(180-data[p2].lon)*DEG;
    const ln=mk('line',{x1:cx+rAsp*Math.cos(a1),y1:cy+rAsp*Math.sin(a1),x2:cx+rAsp*Math.cos(a2),y2:cy+rAsp*Math.sin(a2),stroke:asp.color,'stroke-width':String(asp.width)});
    if(asp.dash) ln.setAttribute('stroke-dasharray',asp.dash);
    svg.appendChild(ln);
  });

  // Natal ring (if provided)
  if(natalData){
    const rN=rI+12;
    natalData.forEach((p,idx)=>{
      if(!p) return;
      const angle=(180-p.lon)*DEG;
      svg.appendChild(mk('text',{
        x:cx+rN*Math.cos(angle),y:cy+rN*Math.sin(angle),
        'text-anchor':'middle','dominant-baseline':'central',
        fill:PLANETS[idx].color+'aa','font-size':'11','font-family':'serif','font-weight':'bold'
      },PLANETS[idx].sym));
    });
  }

  // Moon center
  const phase=moonPhase(data);
  svg.appendChild(mk('circle',{cx,cy,r:30,fill:dark?'#0d1626':'#e8eef8',stroke:dark?'#1e2d4a':'#c0cce0','stroke-width':'1'}));
  if(phase){
    svg.appendChild(mk('text',{x:cx,y:cy-8,'text-anchor':'middle','dominant-baseline':'central','font-size':'20'},phase.emoji));
    svg.appendChild(mk('text',{x:cx,y:cy+12,'text-anchor':'middle','dominant-baseline':'central',fill:dark?'#6080b0':'#4a5a80','font-size':'8','font-weight':'600','font-family':'Raleway,sans-serif'},`${phase.illum}%`));
  }

  // Planet symbols
  data.forEach((p,idx)=>{
    if(!p) return;
    const angle=(180-p.lon)*DEG;
    const dotX=cx+rI*Math.cos(angle),dotY=cy+rI*Math.sin(angle);
    const hit=mk('circle',{cx:dotX,cy:dotY,r:'13',fill:'transparent','pointer-events':'all',cursor:'pointer'});
    const dot=mk('text',{x:dotX,y:dotY,'text-anchor':'middle','dominant-baseline':'central',fill:PLANETS[idx].color,'font-size':PLANETS[idx].isNode?'18':'16','font-family':'serif','font-weight':'bold','pointer-events':'none','filter':'drop-shadow(0 1px 2px rgba(0,0,0,0.4))'},PLANETS[idx].sym);
    const s=signOf(p.lon);
    const degMin=`${s.deg}¬∞${String(s.min).padStart(2,'0')}'`;
    hit.addEventListener('mouseenter',(e)=>{
      const tip=document.getElementById('planetTooltip');
      tip.querySelector('.tip-sym').textContent=PLANETS[idx].sym;
      tip.querySelector('.tip-sym').style.color=PLANETS[idx].color;
      tip.querySelector('.tip-name').textContent=PLANETS[idx].name+' in '+s.name;
      tip.querySelector('.tip-deg').textContent=degMin;
      tip.style.display='flex';
      const rect=svg.getBoundingClientRect();
      const scaleX=rect.width/520,scaleY=rect.height/520;
      const px=rect.left+dotX*scaleX,py=rect.top+dotY*scaleY;
      tip.style.left=px+'px';
      tip.style.top=(dotY>260?py-46:py+16)+'px';
      tip.style.transform='translateX(-50%)';
    });
    hit.addEventListener('mouseleave',()=>document.getElementById('planetTooltip').style.display='none');
    // Touch support
    hit.addEventListener('touchstart',(e)=>{
      e.preventDefault();
      const tip=document.getElementById('planetTooltip');
      tip.querySelector('.tip-sym').textContent=PLANETS[idx].sym;
      tip.querySelector('.tip-sym').style.color=PLANETS[idx].color;
      tip.querySelector('.tip-name').textContent=PLANETS[idx].name+' in '+s.name;
      tip.querySelector('.tip-deg').textContent=degMin;
      tip.style.display='flex';
      const rect=svg.getBoundingClientRect();
      const scaleX=rect.width/520,scaleY=rect.height/520;
      const px=rect.left+dotX*scaleX,py=rect.top+dotY*scaleY;
      tip.style.left=px+'px';
      tip.style.top=(dotY>260?py-46:py+16)+'px';
      tip.style.transform='translateX(-50%)';
      setTimeout(()=>tip.style.display='none',2500);
    });
    svg.appendChild(hit);
    svg.appendChild(dot);
  });
  svg.appendChild(mk('circle',{cx,cy,r:rO,fill:'none',stroke:dark?'#2a3d60':'#8898c0','stroke-width':'1.5'}));
}

// ‚îÄ‚îÄ PLANET TABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderList(data, tbodyId='planet-tbody'){
  const tbody=document.getElementById(tbodyId);
  if(!tbody) return;
  tbody.innerHTML='';
  data.forEach((p,i)=>{
    if(!p) return;
    const s=signOf(p.lon),ms=String(s.min).padStart(2,'0');
    const tr=document.createElement('tr');
    tr.className='fade-in';
    tr.style.animationDelay=(i*0.04)+'s';
    tr.innerHTML=`
      <td class="td-sym"><span style="color:${PLANETS[i].color}">${PLANETS[i].sym}</span></td>
      <td class="td-name">${PLANETS[i].name}</td>
      <td><div class="td-sign"><span class="sign-sym" style="color:${s.color}">${s.sym}</span><span class="sign-nm">${s.name}</span></div></td>
      <td>${p.retrograde?'<span class="retro">Rx</span>':''}</td>
      <td style="text-align:right"><span class="deg-pill">${s.deg}¬∞${ms}'</span></td>`;
    tbody.appendChild(tr);
  });
}

// ‚îÄ‚îÄ ASPECT LEGEND ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAspectLegend(data){
  const aspects=calcAspects(data);
  const seen=new Set();
  const el=document.getElementById('aspectLegend');
  if(!el) return;
  el.innerHTML='';
  aspects.forEach(({asp})=>{
    if(seen.has(asp.name)) return; seen.add(asp.name);
    const item=document.createElement('div'); item.className='asp-item';
    const line=document.createElement('div'); line.className='asp-line';
    line.style.background=asp.color.replace(/[\d.]+\)/,'1)');
    if(asp.dash) line.style.backgroundImage=`repeating-linear-gradient(90deg,${line.style.background} 0,${line.style.background} 4px,transparent 4px,transparent 7px)`;
    item.appendChild(line);
    item.appendChild(document.createTextNode(asp.name));
    el.appendChild(item);
  });
}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentDate=new Date(),isLive=true,isAnimating=false;
let animSpeed=7,animFrame=null,lastAnimTs=null;

// ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function render(d){
  const iso=d.toISOString();
  document.getElementById('current-date').textContent=
    d.toLocaleDateString('en-GB',{weekday:'short',year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit',timeZone:'UTC'})+' UTC';
  document.getElementById('modeBadge').style.display=isLive?'none':'inline-block';
  document.getElementById('liveDot').classList.toggle('paused',!isLive);
  document.getElementById('liveLabel').textContent=isLive?'LIVE':'HISTORICAL';
  document.getElementById('datePicker').value=iso.slice(0,10);
  document.getElementById('timePicker').value=iso.slice(11,16);
  const data=calcData(d);
  renderList(data);
  drawWheel(data);
  const phase=moonPhase(data);
  if(phase){
    document.getElementById('moonEmoji').textContent=phase.emoji;
    document.getElementById('moonName').textContent=phase.name;
    document.getElementById('moonPct').textContent=phase.illum+'%';
    document.getElementById('moonFill').style.width=phase.illum+'%';
  }
  renderAspectLegend(data);
}

// ‚îÄ‚îÄ TIME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function stepDate(d,amount,unit){
  const MS={minute:60000,hour:3600000,day:86400000,week:604800000};
  if(unit==='month'){const nd=new Date(d);nd.setUTCMonth(nd.getUTCMonth()+amount);return nd;}
  if(unit==='year'){const nd=new Date(d);nd.setUTCFullYear(nd.getUTCFullYear()+amount);return nd;}
  return new Date(d.getTime()+amount*(MS[unit]||MS.day));
}
function goToDate(d){currentDate=d;isLive=false;render(currentDate);}
function goLive(){currentDate=new Date();isLive=true;stopAnimation();render(currentDate);}
function startAnimation(){
  if(isAnimating)return;
  isAnimating=true;isLive=false;lastAnimTs=null;
  document.getElementById('animBtn').textContent='‚è∏ Pause';
  document.getElementById('animBtn').classList.add('active');
  (function tick(ts){
    if(!lastAnimTs)lastAnimTs=ts;
    currentDate=new Date(currentDate.getTime()+animSpeed*86400000*(ts-lastAnimTs)/1000);
    lastAnimTs=ts;render(currentDate);
    animFrame=requestAnimationFrame(tick);
  })(performance.now());
}
function stopAnimation(){
  isAnimating=false;
  if(animFrame){cancelAnimationFrame(animFrame);animFrame=null;}
  document.getElementById('animBtn').textContent='‚ñ∂ Play';
  document.getElementById('animBtn').classList.remove('active');
}

// ‚îÄ‚îÄ EVENTS (Sky) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('[data-step]').forEach(b=>b.addEventListener('click',()=>{
  stopAnimation();goToDate(stepDate(currentDate,parseInt(b.dataset.step),b.dataset.unit));
}));
document.getElementById('jumpBtn').addEventListener('click',()=>{
  stopAnimation();
  const dp=document.getElementById('datePicker').value;
  const tp=document.getElementById('timePicker').value||'12:00';
  if(dp) goToDate(new Date(dp+'T'+tp+':00Z'));
});
document.getElementById('nowBtn').addEventListener('click',()=>goLive());
document.getElementById('animBtn').addEventListener('click',()=>isAnimating?stopAnimation():startAnimation());
document.querySelectorAll('[data-animspeed]').forEach(b=>b.addEventListener('click',()=>{
  animSpeed=parseFloat(b.dataset.animspeed);
  document.querySelectorAll('[data-animspeed]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
  if(isAnimating){stopAnimation();startAnimation();}
}));
setInterval(()=>{if(isLive&&!isAnimating){currentDate=new Date();render(currentDate);}},60000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PROFILES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let profiles=JSON.parse(localStorage.getItem('celestia_profiles')||'[]');
let editingProfileId=null;
let selectedProfileId=null;

function saveProfiles(){localStorage.setItem('celestia_profiles',JSON.stringify(profiles));}

window.openAddProfile=function(){
  editingProfileId=null;
  document.getElementById('profileModalTitle').textContent='‚ú¶ Add Birth Profile';
  document.getElementById('pName').value='';
  document.getElementById('pDate').value='';
  document.getElementById('pTime').value='12:00';
  document.getElementById('pPlace').value='';
  document.getElementById('profileModal').classList.add('open');
};
window.closeModal=function(id){document.getElementById(id).classList.remove('open');};

document.getElementById('saveProfileBtn').addEventListener('click',()=>{
  const name=document.getElementById('pName').value.trim();
  const date=document.getElementById('pDate').value;
  const time=document.getElementById('pTime').value||'12:00';
  const place=document.getElementById('pPlace').value.trim();
  if(!name||!date){alert('Please enter at least a name and birth date.');return;}
  const birthDate=new Date(date+'T'+time+':00Z');
  if(editingProfileId){
    const idx=profiles.findIndex(p=>p.id===editingProfileId);
    if(idx>=0){profiles[idx]={...profiles[idx],name,date:birthDate.toISOString(),place};}
  } else {
    profiles.push({id:Date.now().toString(),name,date:birthDate.toISOString(),place});
  }
  saveProfiles();
  closeModal('profileModal');
  renderProfiles();
  refreshTransitSelect();
});

function renderProfiles(){
  const el=document.getElementById('profilesList');
  if(!el) return;
  if(profiles.length===0){
    el.innerHTML='<div class="empty-state"><div class="es-icon">‚ô¶</div><p>No birth profiles yet.<br>Add your first profile to track personal transits.</p></div>';
    document.getElementById('natalSection').style.display='none';
    return;
  }
  el.innerHTML='';
  profiles.forEach(p=>{
    const bd=new Date(p.date);
    const natalData=calcData(bd);
    const sun=natalData[0]?signOf(natalData[0].lon):null;
    const moon=natalData[1]?signOf(natalData[1].lon):null;
    const div=document.createElement('div');
    div.className='profile-card fade-in'+(selectedProfileId===p.id?' selected':'');
    div.innerHTML=`
      <div class="profile-avatar">${p.name[0].toUpperCase()}</div>
      <div class="profile-info">
        <div class="profile-name">${p.name}</div>
        <div class="profile-birth">${bd.toLocaleDateString('en-GB',{year:'numeric',month:'long',day:'numeric'})}${p.place?' ¬∑ '+p.place:''}</div>
        ${sun?`<div class="profile-sun">${PLANETS[0].sym} ${sun.name} ¬∑ ${PLANETS[1].sym} ${moon?.name||'‚Äî'}</div>`:''}
      </div>
      <div class="profile-actions">
        <button class="btn sm gold" onclick="showNatalChart('${p.id}')">Chart</button>
        <button class="btn sm" onclick="editProfile('${p.id}')">Edit</button>
        <button class="btn sm danger" onclick="deleteProfile('${p.id}')">‚úï</button>
      </div>`;
    el.appendChild(div);
  });
}

window.showNatalChart=function(id){
  const p=profiles.find(x=>x.id===id);
  if(!p) return;
  selectedProfileId=id;
  renderProfiles();
  const bd=new Date(p.date);
  const natalData=calcData(bd);
  document.getElementById('natalSection').style.display='block';
  document.getElementById('natalCardTitle').textContent=`${p.name} ¬∑ Natal Chart`;
  drawWheel(natalData,'natal-wheel');
  renderList(natalData,'natal-tbody');
  document.getElementById('natalSection').scrollIntoView({behavior:'smooth'});
};

window.editProfile=function(id){
  const p=profiles.find(x=>x.id===id);
  if(!p) return;
  editingProfileId=id;
  document.getElementById('profileModalTitle').textContent='‚ú¶ Edit Birth Profile';
  document.getElementById('pName').value=p.name;
  const bd=new Date(p.date);
  document.getElementById('pDate').value=bd.toISOString().slice(0,10);
  document.getElementById('pTime').value=bd.toISOString().slice(11,16);
  document.getElementById('pPlace').value=p.place||'';
  document.getElementById('profileModal').classList.add('open');
};

window.deleteProfile=function(id){
  if(!confirm('Delete this profile?')) return;
  profiles=profiles.filter(p=>p.id!==id);
  saveProfiles();
  if(selectedProfileId===id){selectedProfileId=null;document.getElementById('natalSection').style.display='none';}
  renderProfiles();
  refreshTransitSelect();
};

function refreshTransitSelect(){
  const sel=document.getElementById('transitProfileSelect');
  const prev=sel.value;
  sel.innerHTML='<option value="">‚Äî Select Profile ‚Äî</option>';
  profiles.forEach(p=>sel.add(new Option(p.name,p.id)));
  if(profiles.find(p=>p.id===prev)) sel.value=prev;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TRANSIT CALCULATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TRANSIT_ASPECTS=[
  {name:'Conjunction',angle:0,  cls:'conj', sym:'‚òå'},
  {name:'Opposition', angle:180,cls:'opp',  sym:'‚òç'},
  {name:'Trine',      angle:120,cls:'trine',sym:'‚ñ≥'},
  {name:'Square',     angle:90, cls:'square',sym:'‚ñ°'},
  {name:'Sextile',    angle:60, cls:'sext', sym:'‚öπ'},
];

function getOrb(aspName){
  const major=['Conjunction','Opposition','Trine','Square'];
  const val=parseInt(document.getElementById('orbMajor')?.value||3);
  const valMin=parseInt(document.getElementById('orbMinor')?.value||1);
  return major.includes(aspName)?val:valMin;
}

function calcTransits(natalLons, daysAhead){
  const transits=[];
  const now=new Date();
  const step=24; // hours per step
  const totalSteps=Math.ceil(daysAhead*24/step);
  
  for(let s=0;s<=totalSteps;s++){
    const d=new Date(now.getTime()+s*step*3600000);
    const skyData=calcData(d);
    
    for(const tIdx of TRANSIT_PLANETS){
      const tLon=skyData[tIdx]?.lon;
      if(tLon==null) continue;
      
      for(let nIdx=0;nIdx<10;nIdx++){
        const nLon=natalLons[nIdx];
        if(nLon==null) continue;
        
        for(const aspDef of TRANSIT_ASPECTS){
          const orb=getOrb(aspDef.name);
          let diff=Math.abs(tLon-nLon);
          if(diff>180) diff=360-diff;
          const separation=Math.abs(diff-aspDef.angle);
          
          if(separation<=orb){
            const key=`${tIdx}-${nIdx}-${aspDef.name}`;
            const existing=transits.find(t=>t.key===key&&Math.abs(t.date-d)<7*86400000);
            if(!existing){
              transits.push({
                key, date:d, tIdx, nIdx,
                tName:PLANETS[tIdx].name, tSym:PLANETS[tIdx].sym, tColor:PLANETS[tIdx].color,
                nName:PLANETS[nIdx].name, nSym:PLANETS[nIdx].sym, nColor:PLANETS[nIdx].color,
                aspName:aspDef.name, aspSym:aspDef.sym, aspCls:aspDef.cls,
                orb:separation.toFixed(1)
              });
            }
          }
        }
      }
    }
  }
  // Sort by date, deduplicate by key keeping earliest
  const seen=new Set();
  return transits
    .sort((a,b)=>a.date-b.date)
    .filter(t=>{ if(seen.has(t.key)) return false; seen.add(t.key); return true; });
}

document.getElementById('calcTransitsBtn').addEventListener('click',()=>{
  const pid=document.getElementById('transitProfileSelect').value;
  if(!pid){alert('Please select a birth profile first.');return;}
  const p=profiles.find(x=>x.id===pid);
  if(!p) return;
  
  const days=parseInt(document.getElementById('transitDays').value);
  const bd=new Date(p.date);
  const natalData=calcData(bd);
  const natalLons=natalData.map(d=>d?.lon??null);
  
  const btn=document.getElementById('calcTransitsBtn');
  btn.textContent='Calculating‚Ä¶';
  btn.disabled=true;
  
  setTimeout(()=>{
    const transits=calcTransits(natalLons,days);
    renderTransits(transits,p.name);
    btn.textContent='Calculate Transits';
    btn.disabled=false;
  },50);
});

function renderTransits(transits,profileName){
  const el=document.getElementById('transitResults');
  if(!el) return;
  if(transits.length===0){
    el.innerHTML='<div class="empty-state"><div class="es-icon">‚ú¶</div><p>No major transits found in this period.</p></div>';
    return;
  }
  const now=new Date();
  el.innerHTML=`<div style="font-size:11px;color:var(--muted);padding:4px 0 10px;">${transits.length} transit${transits.length>1?'s':''} found for <strong style="color:var(--accent)">${profileName}</strong></div>`;
  const card=document.createElement('div');
  card.className='card';
  card.style.overflow='hidden';
  
  transits.forEach(t=>{
    const daysAway=Math.round((t.date-now)/86400000);
    const dateStr=t.date.toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
    const item=document.createElement('div');
    item.className='transit-item fade-in';
    item.innerHTML=`
      <div class="transit-icon ${t.aspCls}">${t.aspSym}</div>
      <div class="transit-meta">
        <div class="transit-planets">
          <span style="color:${t.tColor}">${t.tSym} ${t.tName}</span>
          <span style="color:var(--muted);margin:0 4px;">${t.aspSym}</span>
          <span style="color:${t.nColor}">natal ${t.nSym} ${t.nName}</span>
        </div>
        <div class="transit-aspect">${t.aspName}</div>
        <div class="transit-date">üìÖ ${dateStr}</div>
      </div>
      <div class="transit-orb">${daysAway===0?'Today':daysAway<0?`${Math.abs(daysAway)}d ago`:`${daysAway}d`}</div>`;
    card.appendChild(item);
  });
  el.appendChild(card);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let notifEnabled=false;

window.toggleNotifications=async function(){
  if(!('Notification' in window)){
    document.getElementById('notifStatus').textContent='Push notifications are not supported on this device/browser.';
    return;
  }
  if(!notifEnabled){
    const perm=await Notification.requestPermission();
    if(perm==='granted'){
      notifEnabled=true;
      document.getElementById('notifToggle').classList.add('on');
      document.getElementById('notifStatus').textContent='‚úì Notifications enabled';
      document.getElementById('notifStatus').style.color='var(--green)';
    } else {
      document.getElementById('notifStatus').textContent='Permission denied. Please enable notifications in your browser settings.';
      document.getElementById('notifStatus').style.color='var(--red)';
    }
  } else {
    notifEnabled=false;
    document.getElementById('notifToggle').classList.remove('on');
    document.getElementById('notifStatus').textContent='Notifications disabled.';
    document.getElementById('notifStatus').style.color='var(--muted)';
  }
};

window.scheduleTransitNotifications=async function(){
  if(!notifEnabled){
    alert('Please enable notifications first.');return;
  }
  const pid=profiles[0]?.id;
  if(!pid){alert('Add a birth profile first to schedule transit notifications.');return;}
  
  const p=profiles[0];
  const bd=new Date(p.date);
  const natalData=calcData(bd);
  const natalLons=natalData.map(d=>d?.lon??null);
  const transits=calcTransits(natalLons,7);
  
  const alertDays=parseInt(document.querySelector('#alertTiming .btn.active')?.dataset.days||1);
  const activeAsps=new Set([...document.querySelectorAll('#alertAspects .btn.active')].map(b=>b.dataset.asp));
  
  let scheduled=0;
  transits.filter(t=>activeAsps.has(t.aspName)).forEach(t=>{
    const notifTime=new Date(t.date.getTime()-alertDays*86400000);
    const delay=notifTime-new Date();
    if(delay>0&&delay<7*86400000){
      setTimeout(()=>{
        new Notification(`‚≠ê Transit Alert ¬∑ ${p.name}`,{
          body:`${t.tName} ${t.aspName} natal ${t.nName}\n${t.date.toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long'})}`,
          icon:'icon-192.png',tag:`transit-${t.key}`
        });
      },delay);
      scheduled++;
    }
  });
  
  const btn=document.getElementById('scheduleNotifBtn');
  btn.textContent=`‚úì Scheduled ${scheduled} alert${scheduled!==1?'s':''}`;
  setTimeout(()=>btn.textContent='Schedule Notifications',3000);
};

// Alert timing / aspect toggles
document.getElementById('alertTiming').querySelectorAll('[data-days]').forEach(b=>b.addEventListener('click',()=>{
  document.getElementById('alertTiming').querySelectorAll('[data-days]').forEach(x=>x.classList.remove('active'));
  b.classList.add('active');
}));
document.getElementById('alertAspects').querySelectorAll('[data-asp]').forEach(b=>b.addEventListener('click',()=>{
  b.classList.toggle('active');
}));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTINGS / THEME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isLight=false;
window.toggleTheme=function(){
  isLight=!isLight;
  document.body.classList.toggle('light',isLight);
  document.getElementById('themeToggle').classList.toggle('on',isLight);
  localStorage.setItem('celestia_theme',isLight?'light':'dark');
  render(currentDate);
  if(selectedProfileId){
    const p=profiles.find(x=>x.id===selectedProfileId);
    if(p){const bd=new Date(p.date);drawWheel(calcData(bd),'natal-wheel');}
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.switchScreen=function(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
  document.querySelector(`[data-screen="${name}"]`).classList.add('active');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INSTALL PROMPT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let deferredInstall=null;
window.addEventListener('beforeinstallprompt',(e)=>{
  e.preventDefault();
  deferredInstall=e;
  document.getElementById('installBanner').style.display='flex';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SERVICE WORKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('sw.js').catch(()=>{});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOTSTRAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function bootstrap(){
  // Restore theme
  const savedTheme=localStorage.getItem('celestia_theme');
  if(savedTheme==='light'){isLight=true;document.body.classList.add('light');document.getElementById('themeToggle').classList.add('on');}

  document.getElementById('loadingMsg').style.display='flex';
  try{
    await initSwe();
    document.getElementById('loadingMsg').style.display='none';
  }catch(e){
    document.getElementById('loadingMsg').innerHTML=`<div style="color:#e05555">‚ö† Swiss Ephemeris error: ${e.message}</div>`;
    return;
  }
  render(currentDate);
  renderProfiles();
  refreshTransitSelect();
  
  // Show install banner after 3s if not already installed
  setTimeout(()=>{
    const isStandalone=window.matchMedia('(display-mode:standalone)').matches||window.navigator.standalone;
    if(!isStandalone&&!deferredInstall){
      document.getElementById('installBanner').style.display='flex';
    }
  },3000);
}
bootstrap();
</script>
</body>
</html>
